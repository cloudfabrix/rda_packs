enabled: true
domain: aiops
description: AIOPs related tools. Typically contains alerts and Incident related tools  related tools to fetch incident information within the fabrix.ai system.Always
    call context-fetch tool if the data is saved in context ** context_cache is set
    to true**.
tools:
    -   name: get_alert_meta_data
        type: streamMetadata
        stream: oia-alerts-stream-ro
        description: Retrieves the complete schema of alert fields available in the
            system.  Always call this tool first when asked about alerts to get the
            relevant fields to query.
    -   name: get_alerts
        type: streamQuery
        stream: oia-alerts-stream-ro
        description: Get Alerts
        save_to_cache: false
        data_format: csv
        response_prefix: Here are alerts in CSV format
        no_data_message: No Alerts found for the specified parameters
        parameters:
            -   name: node_id
                description: Node Id for the alert 
                operator: '='
                queryMapping: a_en_node_id = '{{node_id}}'
            -   name: status
                description: Alert status (e.g. ACTIVE or CLEAR)
                operator: '='
                queryMapping: a_status = '{{status}}'
            -   name: severity
                description: Severity of the alert (e.g. MAJOR, MINOR, HIGH, CRITICAL)
                operator: '='
                queryMapping: a_severity = '{{severity}}'
            -   name: ip_address
                description: Asset IP Address of the alert
                operator: '='
                queryMapping: a_asset_ip_address = '{{ip_address}}'
            -   name: a_incident_id
                description: Incident id of the alert
                operator: '='
                queryMapping: a_incident_id = '{{a_incident_id}}'
            -   name: keyword
                type: string
                description: Keyword to be searched in alerts
                default: null
                queryMapping: a_message contains '{{keyword}}'
            -   name: from_time
                type: string
                description: Query data using a From time, Date and time in ISO format
                default: null
                queryMapping: a_created_ts after '{{from_time}}'
            -   name: to_time
                type: string
                description: Query data using a To time, Date and time in ISO format
                default: null
                queryMapping: a_created_ts before '{{to_time}}'
    -   name: get_alert_count
        type: streamQueryAggs
        stream: oia-alerts-stream-ro
        description: Get Alert Counts. This tool aggregates the alerts based on the
            specified parameters. The exact alert fields to be aggregated can be found
            by calling the get_alert_meta_data tool first.
        save_to_cache: true
        data_format: json
        parameters:
            -   name: groupby
                description: Alert fields to group by. Use comma separated values
                    for multiple fields. Fields can be found by calling the get_alert_meta_data
                    tool first.
                use_in_cfxql: false
            -   name: a_status
                description: Alert status (e.g. ACTIVE or CLEAR)
                operator: '='
                queryMapping: a_status = '{{a_status}}'
            -   name: a_severity
                description: Severity of the alert (e.g. MAJOR, MINOR, HIGH, CRITICAL)
                operator: '='
                queryMapping: a_severity = '{{a_severity}}'
            -   name: a_asset_ip_address
                description: Asset IP Address of the alert
                operator: '='
                queryMapping: a_asset_ip_address = '{{a_asset_ip_address}}'
            -   name: keyword
                type: string
                operator: contains
                description: Keyword to be searched in alerts
                default: null
                queryMapping: a_message contains '{{keyword}}'
            -   name: from_time
                type: string
                description: Query data using a From time, Date and time in ISO format
                default: null
                queryMapping: a_created_ts after '{{from_time}}'
            -   name: to_time
                type: string
                description: Query data using a To time, Date and time in ISO format
                default: null
                queryMapping: a_created_ts before '{{to_time}}'
            -   name: node_id
                description: Node Id for the alert 
                operator: '='
                queryMapping: a_en_node_id = '{{node_id}}'
    -   name: get_incident_meta_data
        type: streamMetadata
        stream: oia-incidents-stream-ro
        description: Retrieves the complete schema of incident fields available in
            the system.  Always call this tool first when asked about incidents to
            get the relevant fields to query.
    -   name: get_incidents
        type: streamQuery
        stream: oia-incidents-stream-ro
        description: Get Incidents
        data_format: csv
        response_prefix: Here are incidents in CSV format
        no_data_message: No Incidents found for the specified parameters
        result_columns:
            i_summary: Summary
            i_priority_label: Priority label
            i_priority: Priority
            incident_id: Incident ID
            i_created_ts: Timestamp
            i_state: State
            i_cfx_incident_occurred: Incident Occurred
            i_itsm_ticket_number: ITSM Number
        parameters:
            -   name: priority_label
                description: Priority label (e.g. MODERATE or HIGH)
                operator: '='
                queryMapping: i_priority_label = '{{priority_label}}'
            -   name: incident_state
                description: Incident State (e.g. Resolved,open)
                operator: '='
                queryMapping: i_state = '{{incident_state}}'
            -   name: incident_id
                description: incident_id of the incident(e.g. CFX20250528126277430e,CFX20250528353721dc6c)
                operator: '='
                queryMapping: incident_id = '{{incident_id}}'
            -   name: keyword
                type: string
                operator: contains
                description: Keyword to be searched in incidents
                default: null
                queryMapping: i_summary contains '{{keyword}}'
            -   name: from_time
                type: string
                description: Query data using a From time, Date and time in ISO format
                default: null
                queryMapping: i_created_ts after '{{from_time}}'
            -   name: to_time
                type: string
                description: Query data using a To time, Date and time in ISO format
                default: null
                queryMapping: i_created_ts before '{{to_time}}'
    -   name: get_incident_count
        type: streamQueryAggs
        stream: oia-incidents-stream-ro
        description: Get incident Counts. This tool aggregates the incidents based
            on the specified parameters. Always call the get_incident_meta_data tool
            first to fetch the exact incident fields to be aggregated.
        data_format: json
        parameters:
            -   name: groupby
                description: incident fields to group by. Use comma separated values
                    for multiple fields. Fields can be found by calling the get_incident_meta_data
                    tool first.
                use_in_cfxql: false
            -   name: priority_label
                description: Priority label (e.g. MODERATE or HIGH)
                operator: '='
                queryMapping: i_priority_label = '{{priority_label}}'
            -   name: incident_state
                description: Incident State (e.g. Resolved,open)
                operator: '='
                queryMapping: i_state = '{{incident_state}}'
            -   name: incident_id
                description: incident_id of the incident(e.g. CFX20250528126277430e,CFX20250528353721dc6c)
                operator: '='
                queryMapping: incident_id = '{{incident_id}}'
            -   name: keyword
                type: string
                description: Keyword to be searched in incidents
                default: null
                queryMapping: i_summary contains '{{keyword}}'
            -   name: from_time
                type: string
                description: Query data using a From time, Date and time in ISO format
                default: null
                queryMapping: i_created_ts after '{{from_time}}'
            -   name: to_time
                type: string
                description: Query data using a To time, Date and time in ISO format
                default: null
                queryMapping: i_created_ts before '{{to_time}}'
    -   name: send_approve_request
        type: runPipeline
        description: Send a user approval request. Call this tool after RCA for an
            incident is done and remediation steps, Request Notes/description about
            what user should approve are returned
        save_to_cache: auto
        result_columns:
            incident_id: Incident ID
            outcome: Recommendation
        custom_config:
            template_type: jinja
            pipeline_content: '@dm:empty

                --> @dm:addrow request_id='''' and user_approval=''Pending'' and submitted_source="{{submitted_source}}"
                and submitted_by="{{user_id}}" and incident_id="{{incident_id}}" and
                outcome="{{outcome}}" and request_notes="{{request_notes}}" and conversation_id=''{{conversation_id}}''
                and approver_userid="{{approver_userid}}"

                --> @dm:eval submitted_time="now()"

                --> @dm:change-time-format columns=''submitted_time'' and from_format=''ms''
                and to_format=''%Y-%m-%dT%H:%M:%S''

                --> @dm:eval request_id="uuid()[:6]"

                --> @dm:enrich-using-pstream dict = ''oia-incidents-stream-ro'' and src_key_cols
                = ''incident_id'' and dict_key_cols = ''incident_id'' and enrich_cols
                = ''project_id''

                --> @dm:eval outcome = "outcome.replace(''\\n'',''\n'')"

                --> @dm:save name=''test-rca''

                --> @rn:write-stream name=''user_approval_stream''

                '
        parameters:
            -   name: incident_id
                description: Incident ID of the user approval request
                type: string
            -   name: approver_userid
                description: User ID of the approver who has the authorized access
                type: string
            -   name: outcome
                description: This is the outcome of the request, consisting of commands
                    to run on the devices
                type: string
            -   name: request_notes
                description: User Approval Request Notes/description about what user
                    should approve and it will include the ip_address
                type: string
    -   name: get_user_approval_request_list
        type: streamQuery
        stream: user_approval_stream
        save_to_cache: auto
        description: Retrieves the complete schema of RCA User Approval fields available
            in the system.All output columns should be shown
        data_format: json
        response_prefix: Here are RCA User Approval in CSV format
        no_data_message: No RCA User Approval found for the specified parameters
        result_columns:
            user_approval: Status
            request_id: Request Id
            submitted_source: Source
            outcome: Outcome
            request_notes: Request Notes
            approver_userid: Approver
        parameters:
            -   name: status
                description: User Approval Request
                queryMapping: user_approval = '{{status}}'
    -   name: approve_user_request
        type: runPipeline
        stream: user_approval_stream
        description: This tool is used to approve a user request. Use the outcome
            and request_notes columns and ALWAYS call the tool run_config_change_command
            tool to execute the commands.
        save_to_cache: auto
        custom_config:
            template_type: jinja
            pipeline_content: "@dm:empty\n    --> @dm:addrow name is \"user_approval_stream\"\
                \n    --> #dm:query-persistent-stream request_id=\"{{request_id}}\"\
                \ and approver_userid=\"{{user_id}}\"\n    --> *exec:if-shape num_rows\
                \ = 0\n    --> @dm:addrow message=\"You are not authorized to approve/reject\
                \ this request\"\n    --> @dm:save name=\"temp-out\"\n    --> @exec:end-if\n\
                \    --> *exec:if-shape num_rows > 0\n    --> @dm:eval updated_time=\"\
                now()\"\n    --> @dm:change-time-format columns='updated_time' and\
                \ from_format='ms' and to_format='%Y-%m-%dT%H:%M:%S'\n    --> @dm:eval\
                \ action_comments=\"'{{action_comments}}'\" and user_approval=\"'{{status}}'\"\
                \n    --> @dm:eval outcome = \"outcome.replace('\\\\n','\\n')\"\n\
                \    --> @rn:write-stream name is \"user_approval_stream\"\n    -->\
                \ @dm:save name=\"temp-out\"\n    --> @exec:end-if\n\n--> @c:new-block\n\
                \    --> @dm:recall name=\"temp-out\"\n"
        parameters:
            -   name: request_id
                description: Request ID of the user approval request
                type: string
            -   name: status
                description: Status of User Approval Request (e.g., approved or rejected)
                type: string
                queryMapping: user_approval = '{{status}}'
            -   name: action_comments
                description: Approval or Rejection comments ( e.g. action performed
                    successfully or action wasn't completed due to reason)
                type: string

    -   name: getServiceNowIncidentSysId
        type: RESTAPI
        description: "Get ServiceNow incident sys_id by incident number"
        data_format: "str"
        http:
            url:
                template: "https://dev271307.service-now.com/api/now/table/incident?sysparm_query=number=INC0010180&sysparm_fields=sys_id"
                template_type: "jinja"
            verify: true
            timeout: 30
            method: "GET"
            headers: '{"Accept": "application/json", "Authorization": "Basic YWRtaW46TXBhbmRhMTIzIQ=="}'

        parameters:
            -   name: incident_number
                type: string
                required: true
                description: "Incident number (e.g., INC0008111)"



    -   name: updateServiceNowIncidentBySysId
        type: RESTAPI
        description: "Update ServiceNow incident by sys_id with comments"
        http:
            url:
                template: "https://dev271307.service-now.com/api/now/table/incident/{{sys_id}}"
                template_type: "jinja"
            verify: true
            timeout: 30
            method: "PUT"
            headers: '{"Accept": "application/json", "Content-Type": "application/json", "Authorization": "Basic YWRtaW46TXBhbmRhMTIzIQ=="}'
            payload:
                template: '{"comments": {{ comments | tojson }}}'
                template_type: "jinja"

        parameters:
            -   name: sys_id
                type: string
                required: true
                description: "The sys_id of the incident to update"
            -   name: comments
                type: string
                required: true
                description: "Comments to add to the incident (e.g., RCA for this incident)"

    -   name: write_rca_to_stream 
        description: Write the entire rca report as a single column in the pstream
        type: streamWrite
        pstream_name: agent_output_stream
        parameters:
          - name: rca_report
            description: Consider the complete RCA report as a string
            type: string
            required: true