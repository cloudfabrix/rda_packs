##This pipeline needs customer_tag or customerTag in context 
##If its not provided to the pipeline it does not run
%% stream = no and limit = 0
%% template_type="jinja"
%% import_src_type = "cisco-crosswork"
%%start_inline_object name="context_dynamic_form" and type="data" and format="json"
{
    "formFieldList": [
        {
            "fieldId": "customer_tag",
            "label": "Tag of the customer",
            "required": false,
            "dataType": "string"
        }
    ]
}
%%end_inline_object
--> @dm:empty
    --> @dm:save name="temp-customer-context"
   {% if customer_tag %} 
      {% set customer_id = customer_id %}
      {% set customer_tag = customer_tag %}
      {% set customerTag = customer_tag %}
   {% elif customerTag %} 
      {% set customer_id = customer_id %}
      {% set customer_tag = customerTag %}
   {% else %}
      {% set customer_id = '' %}
      {% set customer_tag = '' %}
   {% endif %}   


## Get input - ondemand execution
--> @c:new-block
    --> @exec:get-input 
    --> @dm:save name="temp-access-verify"

## Process ondemand input if exists
--> @c:new-block
    --> @dm:recall name="temp-access-verify" and return_empty = "yes"
    --> @dm:skip-block-if-shape row_count = 0
    --> @dm:selectcolumns include="Others"
    --> @dm:explode-json column="Others"
    --> @dm:rename-columns cisco_crosswork_src_name='name'
    --> @dm:save name='temp-cisco_crosswork_source_info'

## Scheduled execution - query persistent streams
--> @c:new-block
    --> @dm:recall name="temp-access-verify" and return_empty = "yes"
    --> @dm:skip-block-if-shape row_count > 0
    --> @dm:empty
   --> @dm:save name='temp-cisco-crosswork-sources'
   --> @dm:save name='temp-variable-dataset-interim'
    {% if customer_tag %} 
       --> #dm:query-persistent-stream type contains 'cisco-crosswork' and (customerTag contains '{{customer_tag}}') with-input name='rda_secrets_meta' and limit=0
    {% else %}
       --> #dm:query-persistent-stream type contains 'cisco-crosswork' and (customerTag is empty or customerTag is 'None') with-input name='rda_secrets_meta' and limit=0
    {% endif %}    
    --> @dm:save name='temp-cisco-crosswork-sources'
    --> @dm:recall name='temp-cisco-crosswork-sources'
    
    --> @exec:for-loop num_rows=1
       --> #dm:query-persistent-stream cisco_crosswork_src_name contains '{%-raw-%}{{row["name"]}}{%-endraw-%}'  with-input name='cisco_crosswork_on_boarded_devices' and limit=0
       --> @dm:save name='temp-variable-dataset-interim' & append='yes' & return_appended_dataset='yes'
    --> @exec:end-loop
    
    --> @dm:recall name='temp-variable-dataset-interim'
    
    --> *exec:if-shape num_rows=0    
       --> @dm:recall name='temp-cisco-crosswork-sources'
       --> @dm:eval  discovery_scope="'yes'"
       --> @dm:rename-columns cisco_crosswork_src_name='name'
       --> @dm:save name='temp-cisco_crosswork_source_info'
   --> @exec:end-if
   
    --> *exec:if-shape num_rows>0  
       --> *dm:safe-filter discovery_scope=='yes'
       --> *dm:filter * get cisco_crosswork_src_name,ip_address,discovery_scope
       --> @dm:save name='temp-cisco_crosswork_source_info'
   --> @exec:end-if
##Add customer context to the dataset
--> @c:new-block
    --> @dm:recall name='temp-cisco_crosswork_source_info'
    --> @dm:eval customer_id="'{{customer_id}}'"
    --> @dm:eval customer_tag="'{{customer_tag}}'"
   --> @dm:save name='temp-cisco_crosswork_source_info'


## --> @c:new-block
## --> @dm:empty
## --> #dm:query-persistent-stream  customer_id is '{{customer_id}}' with-input name = "cisco_crosswork_on_boarded_devices" & limit = "0"
## --> @dm:skip-pipeline-if-shape row_count = 0
## --> @dm:map attr = 'discovery_scope' & func = 'strip'
## --> @dm:map attr = 'discovery_scope' & func = 'lower'
## --> @dm:fixnull columns="discovery_scope" & value='yes'
## --> *dm:filter discovery_scope = 'yes'
## --> @dm:save name="temp-cisco_crosswork_source_info"
## --> @dm:save name = 'test3'
## Cisco Crosswork Devices Information
--> @c:data-loop dataset = 'temp-cisco_crosswork_source_info' & columns = 'cisco_crosswork_src_name,customer_id,customer_tag,discovery_scope'
    --> @dm:recall name = 'temp-cisco_crosswork_source_info'

    --> @$cisco_crosswork_src_name:devices column_name='ip_address'  & concurrent_discovery = '100'
    --> *exec:if-condition collection_status != 'Success'
        --> @dm:eval customer_id = "'$customer_id'"
       --> @dm:eval customer_tag = "'$customer_tag'"
       --> @dm:eval discovery_scope = "'$discovery_scope'"
       --> *dm:filter * get source_ip as 'asset_ip',collection_status,collection_timestamp,reason as 'collection_reason',customer_id,customer_tag,discovery_scope
       --> @dm:map attr = 'collection_timestamp' & func = 'ts_to_datetimestr' & unit = 'ms'
       --> @dm:eval bot_source_name = "'$cisco_crosswork_src_name'"
       --> @dm:eval bot_source_type = "'cisco_crosswork'"
       --> @dm:eval bot_name = "'devices'"
       --> @dm:save name = 'temp-cisco_crosswork_devices_info_failed_status'
       --> @rn:write-stream name = 'cisco_crosswork_access_verification_status'
    --> @exec:end-if
    --> *exec:if-condition collection_status = 'Success'
       --> @dm:save name = 'temp-cisco_crosswork_devices_info_inventory'
               --> @dm:eval customer_id = "'$customer_id'"
       --> @dm:eval customer_tag = "'$customer_tag'"
       --> @dm:eval discovery_scope = "'$discovery_scope'"
       --> @dm:dedup columns = 'source_ip'
       --> *dm:filter * get source_ip as 'asset_ip',collection_status,collection_timestamp,reason as 'collection_reason',customer_id,customer_tag,discovery_scope
       --> @dm:map attr = 'collection_timestamp' & func = 'ts_to_datetimestr' & unit = 'ms'
       --> @dm:eval bot_source_name = "'$cisco_crosswork_src_name'"
       --> @dm:eval bot_source_type = "'cisco_crosswork'"
       --> @dm:eval bot_name = "'devices'"
       --> @dm:save name = 'temp-cisco_crosswork_devices_info_success_status'
       --> @rn:write-stream name = 'cisco_crosswork_access_verification_status'
    --> @exec:end-if