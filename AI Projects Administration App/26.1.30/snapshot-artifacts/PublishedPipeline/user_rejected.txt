%% stream = no and limit = 0

@exec:get-input
    --> @dm:save name ="test-approve"

--> @c:data-loop dataset="test-approve" and columns="request_id,USER_ID"
    --> @dm:empty
    --> @dm:addrow name is "user_approval_stream"
    --> #dm:query-persistent-stream request_id= "$request_id"
    --> @dm:save name="test-approve-data"
    --> *exec:if-shape num_rows = 0
       --> @dm:addrow message="You are not authorized to reject this request"
       --> @dm:save name="temp-out"
       --> @dm:save name='test-approval'
    --> @exec:end-if
    --> *exec:if-shape num_rows > 0
       --> @dm:eval updated_time="now()"
       --> @dm:change-time-format columns='updated_time' and from_format='ms' and to_format='%Y-%m-%dT%H:%M:%S'
       --> @dm:eval action_comments="' action performed successfully '" and user_approval="'Rejected'"
       --> @rn:write-stream name is "user_approval_stream"
       --> @dm:eval message="'Request is successfully rejected'"
       --> @dm:save name="temp-out"
       --> @dm:save name='test-approval'
    --> @exec:end-if
    --> @dm:empty
    --> @dm:addrow message = 'User Approval for the Root Cause Analysis Agent/Workflow was rejected.' and channel = '#test_cfxdx_slack'
    --> @slack:post-message-to-channel channel_col = 'channel' and message_col = 'message'