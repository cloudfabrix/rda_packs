%% stream = no and limit = 0

@dm:query-persistent-stream-from-bookmark name="rda_chat_sessions" and bookmark="rda_chat_session" and query = "type not in ['client','breakpoint'] and (token_usage_input_tokens is not None or token_usage_output_tokens is not None or tool_name is not None or request_status is not None ) GET request_type,request_subtype,USER_ID,context_USER_GROUP_NAME,persona,persona_name,llm,token_usage_input_tokens,tool_domain,tool_name,tool_status,token_usage_output_tokens,count_,request_status,provider,_RDA_Id,ai_project_name"
    --> @dm:save name="after-get"
    --> @dm:skip-pipeline-if-shape row_count=0
    --> @dm:add-missing-columns columns = 'persona_name,persona,llm_name,llm'
    --> @dm:eval persona = 'persona if persona else persona_name'
    --> @dm:eval llm_unified = 'llm if llm and llm != "" else (llm_name if llm_name and llm_name != "" else None)'
    --> @dm:save name="before-renaming"
    --> @dm:selectcolumns exclude='llm$'
    --> @dm:rename-columns llm_provider = 'provider' and user_id = 'USER_ID' and user_group = 'context_USER_GROUP_NAME' and ai_persona = 'persona' and llm_hosted_by = 'hosted_by' and llm='llm_unified'
    --> @dm:save name="after-renaming"
    --> @dm:add-missing-columns columns = 'user_group,token_usage_input_tokens'
    --> @dm:eval user_group="'user_group' if user_group is None or user_group is '' else user_group"
    --> @dm:to-type columns = 'token_usage_input_tokens' and type = 'float'
    --> @dm:eval token_usage_input_tokens="float(token_usage_input_tokens) if token_usage_input_tokens else 0"
    --> @dm:save name = 'rda-chat-session-data'
    --> @exec:run-pipeline name='model_cost_observability_pipeline_child'