%% stream = no and limit = 0

@exec:get-input
    --> @dm:save name= 'temp-rda-chat-session-data1'

--> @c:new-block
    --> @dm:recall name is 'temp-rda-chat-session-data1'
    --> @dm:add-missing-columns columns = 'token_usage_input_tokens,request_type,request_subtype,user_id,user_group,ai_persona,llm,ai_project_name'
    --> *dm:safe-filter token_usage_input_tokens is not None
    --> @dm:skip-block-if-shape row_count = 0
    --> @dm:selectcolumns include = 'request_type|request_subtype|user_id|user_group|ai_persona|^llm$|token_usage_input_tokens|ai_project_name'
    --> @dm:groupby columns = 'request_type,request_subtype,user_id,user_group,ai_persona,llm,ai_project_name' and agg = sum
    --> @dm:save name="rda_chat_session_data"
    --> @dm:eval metric_name = "'token_count'" and metric_value = 'token_usage_input_tokens' and direction = "'input'"
    --> @dm:eval config_id="uuid()"
    --> @dm:enrich dict = 'llm_model_costs' and src_key_cols = 'llm' and dict_key_cols = 'llm_name' and enrich_cols = 'input_token_cost_per1M,provider,hosted_by' and how_type='right'
    --> @dm:selectcolumns exclude="llm_name"
    --> @dm:rename-columns llm_provider = 'provider' and llm_hosted_by = 'hosted_by' and llm_name= 'llm'
    --> @dm:to-type columns='metric_value' and type='float'
    --> @dm:save name="before-enrich"
    --> @dm:dropnull columns="llm_name"
    --> @dm:save name="token_usage_input_tokens"
    --> @rn:write-stream name = 'ai_observability'

--> @c:new-block
    --> @dm:recall name = 'temp-rda-chat-session-data1'
    --> @dm:add-missing-columns columns = 'token_usage_output_tokens,request_type,request_subtype,user_id,user_group,ai_persona,llm,ai_project_name'
    --> *dm:safe-filter token_usage_output_tokens is not None
    --> @dm:skip-block-if-shape row_count = 0
    --> @dm:selectcolumns include = 'request_type|request_subtype|user_id|user_group|ai_persona|^llm$|token_usage_output_tokens|ai_project_name'
    --> @dm:groupby columns = 'request_type,request_subtype,user_id,user_group,ai_persona,llm,ai_project_name' and agg = sum
    --> @dm:eval metric_name = "'token_count'" and metric_value = 'token_usage_output_tokens' and direction = "'output'"
    --> @dm:eval config_id="uuid()"
    --> @dm:enrich dict = 'llm_model_costs' and src_key_cols = 'llm' and dict_key_cols = 'llm_name' and enrich_cols = 'input_token_cost_per1M,provider,hosted_by' and how_type='right'
    --> @dm:selectcolumns exclude="llm_name"
    --> @dm:rename-columns llm_provider = 'provider' and llm_hosted_by = 'hosted_by' and llm_name= 'llm'
    --> @dm:to-type columns='metric_value' and type='float'
    --> @dm:dropnull columns="llm_name"
    --> @dm:save name="token_count_output"
    --> @rn:write-stream name = 'ai_observability'

--> @c:new-block
    --> @dm:recall name = 'temp-rda-chat-session-data1'
    --> @dm:add-missing-columns columns = 'token_usage_input_tokens,request_type,request_subtype,user_id,user_group,ai_persona,llm,ai_project_name'
    --> *dm:safe-filter token_usage_input_tokens is not None
    --> @dm:skip-block-if-shape row_count = 0
    --> @dm:selectcolumns include = 'request_type|request_subtype|user_id|user_group|ai_persona|^llm$|token_usage_input_tokens|ai_project_name'
    --> @dm:eval token_usage_input_tokens = 'float(token_usage_input_tokens) / 1000000.0'
    --> @dm:enrich dict = 'llm_model_costs' and src_key_cols = 'llm' and dict_key_cols = 'llm_name' and enrich_cols = 'input_token_cost_per1M,provider,hosted_by' and how_type='right'
    --> @dm:rename-columns llm_provider = 'provider' and llm_hosted_by = 'hosted_by' and llm_name= 'llm'
    --> @dm:fixnull columns = 'token_usage_input_tokens' and value = '0' and apply_for_empty = 'yes'
    --> @dm:to-type columns = 'input_token_cost_per1M,token_usage_input_tokens' and type = 'float'
    --> @dm:eval metric_name = "'token_cost'" and metric_value = "input_token_cost_per1M * token_usage_input_tokens" and direction = "'input'" and currency = '"USD"'
    --> @dm:to_type columns = 'metric_value' &
            type  = 'float'
    --> @dm:eval config_id="uuid()"
    --> @dm:dropnull columns="llm_name"
    --> @rn:write-stream name = 'ai_observability'
    --> @dm:save name="token_cost_input"

--> @c:new-block
    --> @dm:recall name = 'temp-rda-chat-session-data1'
    --> @dm:add-missing-columns columns = 'token_usage_output_tokens,request_type,request_subtype,user_id,user_group,ai_persona,llm,ai_project_name'
    --> *dm:safe-filter token_usage_output_tokens is not None
    --> @dm:skip-block-if-shape row_count = 0
    --> @dm:selectcolumns include = 'request_type|request_subtype|user_id|user_group|ai_persona|^llm$|token_usage_output_tokens|ai_project_name'
    --> @dm:eval token_usage_output_tokens = 'float(token_usage_output_tokens) / 1000000.0'
    --> @dm:enrich dict = 'llm_model_costs' and src_key_cols = 'llm' and dict_key_cols = 'llm_name' and enrich_cols = 'output_token_cost_per1M,provider,hosted_by' and how_type='right'
    --> @dm:selectcolumns exclude="llm_name"
    --> @dm:rename-columns llm_provider = 'provider' and llm_hosted_by = 'hosted_by' and llm_name= 'llm'
    --> @dm:fixnull columns = 'token_usage_output_tokens' and value = '0' and apply_for_empty = 'yes'
    --> @dm:to-type columns = 'output_token_cost_per1M,token_usage_output_tokens' and type = 'float'
    --> @dm:eval metric_name = "'token_cost'" and metric_value  = "output_token_cost_per1M * token_usage_output_tokens" and direction = "'output'" and currency = "'USD'"
    --> @dm:to_type columns = 'metric_value' &
            type  = 'float'
    --> @dm:eval config_id="uuid()"
    --> @dm:dropnull columns="llm_name"
    --> @rn:write-stream name = 'ai_observability'
    --> @dm:save name="token_cost_output"

--> @c:new-block
    --> @dm:recall name = 'temp-rda-chat-session-data1'
    --> @dm:add-missing-columns columns = 'tool_name,request_type,request_subtype,user_id,user_group,ai_persona,llm,ai_project_name,tool_domain,tool_status'
    --> *dm:safe-filter tool_name is not None
    --> @dm:skip-block-if-shape row_count = 0
    --> @dm:selectcolumns include = 'request_type|request_subtype|user_id|user_group|ai_persona|^llm$|count_|tool_domain|tool_name|tool_status|ai_project_name'
    --> @dm:save name = 'tool_name_before_groupby'
    --> @dm:groupby columns = 'request_type,request_subtype,user_id,user_group,ai_persona,llm,tool_domain,tool_name,tool_status,ai_project_name' and agg = sum
    --> @dm:enrich dict = 'llm_model_costs' and src_key_cols = 'llm' and dict_key_cols = 'llm_name' and enrich_cols = 'provider,hosted_by' and how_type='right'
    --> @dm:selectcolumns exclude="llm_name"
    --> @dm:eval metric_name = "'tools_called'" and metric_value = 'count_'
    --> @dm:rename-columns llm_provider = 'provider' and llm_hosted_by = 'hosted_by' and llm_name= 'llm'
    --> @dm:to-type columns='metric_value' and type='float'
    --> @dm:eval config_id="uuid()"
    --> @dm:dropnull columns="llm_name"
    --> @dm:save name = 'tools_called_Data'
    --> @rn:write-stream name = 'ai_observability'

--> @c:new-block
    --> @dm:recall name = 'temp-rda-chat-session-data1'
    --> @dm:add-missing-columns columns = 'request_status,request_type,request_subtype,user_id,user_group,ai_persona,llm,ai_project_name'
    --> *dm:safe-filter request_status is not None
    --> @dm:skip-block-if-shape row_count = 0
    --> @dm:selectcolumns include = 'request_type|request_subtype|user_id|user_group|ai_persona|^llm$|count_|request_status|ai_project_name'
    --> @dm:groupby columns = 'request_type,request_subtype,user_id,user_group,ai_persona,llm,request_status,ai_project_name'
    --> @dm:enrich dict = 'llm_model_costs' and src_key_cols = 'llm' and dict_key_cols = 'llm_name' and enrich_cols = 'provider,hosted_by' and how_type='right'
    --> @dm:selectcolumns exclude="llm_name"
    --> @dm:eval metric_name = "'request_count'" and metric_value = 'count_'
    --> @dm:to-type columns='metric_value' and type='float'
    --> @dm:rename-columns llm_provider = 'provider' and llm_hosted_by = 'hosted_by' and llm_name= 'llm'
    ## --> @dm:save name = 'status_count'
    --> @dm:eval config_id="uuid()"
    --> @dm:dropnull columns="llm_name"
    --> @rn:write-stream name = 'ai_observability'
    --> @dm:save name = 'status_count'