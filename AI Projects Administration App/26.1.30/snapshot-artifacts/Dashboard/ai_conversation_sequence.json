{
  "name": "ai_conversation_sequence",
  "description": "Conversation Sequence",
  "label": "AI Interaction Sequence",
  "enabled": false,
  "dashboard_type": "dashboard",
  "dashboard_folder": "AI",
  "live_edit": true,
  "dashboard_filters": {
      "time_filter": false,
      "default_time_filter_labels0": [
          "All Time"
      ]
  },
  "dashboard_sections": [
      {
          "title": "Simplified",
          "show_filter": true,
          "widgets": [
              {
                  "title": "Simplified",
                  "widget_type": "persistent_custom_widget",
                  "widget_implementation": "ai_conversation_sequence/sequenceGraphSimplified",
                  "height": 12,
                  "min_width": 12,
                  "fixed_variables": {},
                  "widget_id": "rdafmsSeqSimplified"
              }
          ]
      },
      {
          "title": "Complete Sequence",
          "show_filter": true,
          "widgets": [
              {
                  "title": "AI Interaction",
                  "widget_type": "persistent_custom_widget",
                  "widget_implementation": "ai_conversation_sequence/sequenceGraph",
                  "height": 12,
                  "min_width": 12,
                  "fixed_variables": {
                      "a": "b"
                  },
                  "widget_id": "rdafmsSeq"
              }
          ]
      }
  ],
  "custom_widgets": {
      "sequenceGraph": {
          "artifacts": {
              "main": {
                  "attachment": "aiSequenceMonoColor",
                  "content_type": "text/html",
                  "is_template": true
              }
          }
      },
      "sequenceGraphSimplified": {
          "artifacts": {
              "main": {
                  "attachment": "aiSequenceSimplified",
                  "content_type": "text/html",
                  "is_template": true
              }
          }
      }
  },
  "saved_time": "2025-10-16T18:59:00.576155",
  "attachments": [
      {
          "name": "aiSequenceMonoColor_1",
          "value": "\n{%-\n  set cfxql_query2 = \"conversationId = '\"+ conversation_id + \"' GET USER_ID,persona,message,conversationLabel,timestamp,type,llm,tool_name,tool_domain,tool_content\"\n-%}\n\n\n{%-\n    set rows = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2, sorting=[{\"timestamp\": \"asc\"}], limit=1000, max_rows=1000)\n-%}\n\n{%- set conversationLabel = \"\" -%}\n{%- if len(rows) > 0 -%}\n    {%- set conversationLabel = rows[0].get(\"conversationLabel\", \"\") -%}\n{%- endif -%}\n\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>AI Interaction Diagram - Dark Theme</title>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js\"></script>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            margin: 0;\n            padding: 10px;\n            background-color: #1a1a1a;\n            color: #e0e0e0;\n            height: 100vh;\n            box-sizing: border-box;\n        }\n        .container {\n            width: 100%;\n            height: calc(100vh - 20px);\n            background: #2d2d2d;\n            padding: 15px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n            border: 1px solid #404040;\n            box-sizing: border-box;\n            display: flex;\n            flex-direction: column;\n        }\n        h1 {\n            color: #ffffff;\n            text-align: center;\n            margin: 0 0 20px 0;\n            flex-shrink: 0;\n        }\n        .diagram-container {\n            width: 100%;\n            overflow-x: auto;\n            border: 1px solid #555;\n            border-radius: 4px;\n            padding: 15px;\n            background: #242424;\n            flex: 1;\n            min-height: 0;\n        }\n       \n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1 id=\"diagram-title\">AI Interaction Diagram</h1>\n        \n\n\n\n\n\n\n        <div class=\"diagram-container\">\n            <div id=\"diagram\"></div>\n        </div>\n    </div>\n\n    <script>\n        // Sample data from the user\n        let currentData = {{json_dumps(rows)}};\n\n        // Initialize Mermaid with dark theme\n        mermaid.initialize({ startOnLoad: false, theme: 'dark', maxTextSize: 100000, sequence: { showSequenceNumbers: true } });\n\n        function generateSequenceDiagram(data, conversationLabel = \"Default Conversation\") {\n            \n            \n            let mermaidCode = \"sequenceDiagram\\n\";\n            \n            // Update title\n            document.getElementById('diagram-title').textContent = `AI Interaction Diagram: ${conversationLabel}`;\n            \n            // Define participants based on the data\n            const userId = data[0].USER_ID || \"Client\";\n            let clientType = \"Agents\";\n            if (userId.includes(\"@\")) {\n                clientType = \"Users\";\n            };\n            const userIdShort = userId.split('@')[0]; // Get the username part for cleaner display\n            const llmName = data[0].llm || data.at(-1).llm || \"LLM\"; // Get LLM name from data\n            \n            mermaidCode += `    box rgb(80,80,200) ${clientType}\\n`;\n            mermaidCode += `    participant Client as ${userIdShort}\\n`;\n            mermaidCode += `    end\\n`;\n            mermaidCode += `    participant MCP_Client as MCP Client\\n`;\n            mermaidCode += `    box rgb(100,0,100) AI Models\\n`;\n            mermaidCode += `    participant ${llmName} as ${llmName}\\n`;\n            mermaidCode += `    end\\n`;\n            mermaidCode += `    participant MCP_Server as MCP Server\\n`;\n\n            mermaidCode += `    box rgb(30,81, 40) Tool Domains\\n`;\n            \n            // Get unique tool domains\n            const toolDomains = [...new Set(data\n                .filter(item => item.tool_domain)\n                .map(item => item.tool_domain))];\n            \n            toolDomains.forEach(domain => {\n                mermaidCode += `    participant ${domain} as ${domain}\\n`;\n            });\n\n            mermaidCode += `    end\\n`;\n            \n            mermaidCode += \"\\n\";\n            let rectToggle = false;\n            \n            // Process each data entry according to the rules\n            data.forEach((item, index) => {\n                if (item.type === \"client\") {\n                    // Rule: Draw line from client to MCP Client and then from MCP Client to LLM\n                    const persona = item.persona || \"Unknown\"\n                    const shortMessage = item.message.length > 30 \n                        ? item.message.substring(0, 30) + \"...\" \n                        : item.message;\n                    mermaidCode += `    Client->>MCP_Client: [${persona}] ${shortMessage.replace(/\\n/g, ' ')}\\n`;\n                    mermaidCode += `    MCP_Client->>+${llmName}: Forward request + System Instructions\\n\\n`;\n                    \n                } else if (item.type === \"Assistant\" && item.tool_name) {\n                    // Rule: Tool calling sequence\n                    const toolName = item.tool_name;\n                    const toolDomain = item.tool_domain;\n                    \n                    mermaidCode += `    note left of ${llmName}: Tool Call ${toolName}\\n`;\n                    const rectColor = rectToggle ? 'rgba(120, 120, 120, 0.8)' : 'rgba(120, 120, 120, 0.8)';\n                    mermaidCode += `    rect ${rectColor}\\n`;\n                   \n                    mermaidCode += `        ${llmName}->>MCP_Client: ${toolName}\\n`;\n                    mermaidCode += `        MCP_Client->>MCP_Server: ${toolName}\\n`;\n                    mermaidCode += `        MCP_Server->>${toolDomain}: ${toolName}\\n`;\n                    mermaidCode += `        ${toolDomain}->>MCP_Server: ${toolName} Response\\n`;\n                    mermaidCode += `        MCP_Server->>MCP_Client: ${toolName} Response\\n`;\n                    mermaidCode += `        MCP_Client->>${llmName}: ${toolName} Response\\n`;\n                    mermaidCode += `    end\\n\\n`;\n\n                    rectToggle = !rectToggle;\n                    \n                } else if (item.type === \"Assistant\" && !item.tool_name) {\n                    // Rule: Response from LLM to MCP_Client and then to User with \"Response\" label\n                    mermaidCode += `    ${llmName}->>MCP_Client: Response\\n`;\n                    mermaidCode += `    MCP_Client->>Client: Response\\n`;\n                }\n            });\n            \n            return mermaidCode;\n        }\n\n        function generateDiagram(conversationLabel = \"Security PSIRT Analysis\") {\n            try {\n                const mermaidCode = generateSequenceDiagram(currentData, conversationLabel);\n                \n                // Clear previous diagram\n                const diagramDiv = document.getElementById('diagram');\n                diagramDiv.innerHTML = '';\n                \n                // Render new diagram\n                mermaid.render('sequence-diagram', mermaidCode)\n                    .then(result => {\n                        diagramDiv.innerHTML = result.svg;\n                    })\n                    .catch(error => {\n                        console.error('Error rendering diagram:', error);\n                        diagramDiv.innerHTML = '<p style=\"color: #ff6b6b;\">Error rendering diagram. Check console for details.</p>';\n                    });\n            } catch (error) {\n                console.error('Error generating diagram:', error);\n                document.getElementById('diagram').innerHTML = '<p style=\"color: #ff6b6b;\">Error processing data: ' + error.message + '</p>';\n            }\n        }\n\n\n\n        // Function to use custom data programmatically\n        function useCustomData(newData, conversationLabel = \"Custom Conversation\") {\n            currentData = newData;\n            generateDiagram(conversationLabel);\n        }\n\n        // Generate initial diagram\n        window.onload = function() {\n            generateDiagram(conversationLabel=\"{{conversationLabel}}\");\n        };\n    </script>\n</body>\n</html>"
      },
      {
          "name": "backup",
          "value": "\n{%-\n  set cfxql_query2 = \"conversationId = '\"+ conversation_id + \"' GET USER_ID,persona,message,conversationLabel,timestamp,type,llm,tool_name,tool_domain,tool_content\"\n-%}\n\n\n{%-\n    set rows = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2, sorting=[{\"timestamp\": \"asc\"}], limit=1000, max_rows=1000)\n-%}\n\n{%- set conversationLabel = \"\" -%}\n{%- if len(rows) > 0 -%}\n    {%- set conversationLabel = rows[0].get(\"conversationLabel\", \"\") -%}\n{%- endif -%}\n\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>AI Interaction Diagram - Dark Theme</title>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js\"></script>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            margin: 0;\n            padding: 10px;\n            background-color: #1a1a1a;\n            color: #e0e0e0;\n            height: 100vh;\n            box-sizing: border-box;\n        }\n        .container {\n            width: 100%;\n            height: calc(100vh - 20px);\n            background: #2d2d2d;\n            padding: 15px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n            border: 1px solid #404040;\n            box-sizing: border-box;\n            display: flex;\n            flex-direction: column;\n        }\n        h1 {\n            color: #ffffff;\n            text-align: center;\n            margin: 0 0 20px 0;\n            flex-shrink: 0;\n        }\n        .diagram-container {\n            width: 100%;\n            overflow-x: auto;\n            border: 1px solid #555;\n            border-radius: 4px;\n            padding: 15px;\n            background: #242424;\n            flex: 1;\n            min-height: 0;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1 id=\"diagram-title\">AI Interaction Diagram</h1>\n        \n\n\n\n\n\n\n        <div class=\"diagram-container\">\n            <div id=\"diagram\"></div>\n        </div>\n    </div>\n\n    <script>\n        // Sample data from the user\n        let currentData = {{json_dumps(rows)}};\n\n        // Initialize Mermaid with dark theme\n        mermaid.initialize({ startOnLoad: false, theme: 'dark' });\n\n        function generateSequenceDiagram(data, conversationLabel = \"Default Conversation\") {\n            let mermaidCode = \"sequenceDiagram\\n\";\n            \n            // Update title\n            document.getElementById('diagram-title').textContent = `AI Interaction Diagram: ${conversationLabel}`;\n            \n            // Define participants based on the data\n            const userId = data[0].USER_ID || \"Client\";\n            const userIdShort = userId.split('@')[0]; // Get the username part for cleaner display\n            const llmName = data[0].llm || data.at(-1).llm || \"LLM\"; // Get LLM name from data\n            \n            mermaidCode += `    participant Client as ${userIdShort}\\n`;\n            mermaidCode += `    participant MCP_Client as MCP Client\\n`;\n            mermaidCode += `    participant ${llmName} as ${llmName}\\n`;\n            mermaidCode += `    participant MCP_Server as MCP Server\\n`;\n            \n            // Get unique tool domains\n            const toolDomains = [...new Set(data\n                .filter(item => item.tool_domain)\n                .map(item => item.tool_domain))];\n            \n            toolDomains.forEach(domain => {\n                mermaidCode += `    participant ${domain} as ${domain}\\n`;\n            });\n            \n            mermaidCode += \"\\n\";\n            \n            // Process each data entry according to the rules\n            data.forEach((item, index) => {\n                if (item.type === \"client\") {\n                    // Rule: Draw line from client to MCP Client and then from MCP Client to LLM\n                    const shortMessage = item.message.length > 40 \n                        ? item.message.substring(0, 40) + \"...\" \n                        : item.message;\n                    mermaidCode += `    Client->>MCP_Client: ${shortMessage.replace(/\\n/g, ' ')}\\n`;\n                    mermaidCode += `    MCP_Client->>${llmName}: Forward request + System Instructions\\n\\n`;\n                    \n                } else if (item.type === \"openai\" && item.tool_name) {\n                    // Rule: Tool calling sequence\n                    const toolName = item.tool_name;\n                    const toolDomain = item.tool_domain;\n                    \n                    mermaidCode += `    ${llmName}->>MCP_Client: ${toolName}\\n`;\n                    mermaidCode += `    MCP_Client->>MCP_Server: ${toolName}\\n`;\n                    mermaidCode += `    MCP_Server->>${toolDomain}: ${toolName}\\n`;\n                    \n                    // Response in reverse order with tool_name + \" Response\" labels\n                    mermaidCode += `    ${toolDomain}->>MCP_Server: ${toolName} Response\\n`;\n                    mermaidCode += `    MCP_Server->>MCP_Client: ${toolName} Response\\n`;\n                    mermaidCode += `    MCP_Client->>${llmName}: ${toolName} Response\\n\\n`;\n                    \n                } else if (item.type === \"openai\" && !item.tool_name) {\n                    // Rule: Response from LLM to MCP_Client and then to User with \"Response\" label\n                    mermaidCode += `    ${llmName}->>MCP_Client: Response\\n`;\n                    mermaidCode += `    MCP_Client->>Client: Response\\n`;\n                }\n            });\n            \n            return mermaidCode;\n        }\n\n        function generateDiagram(conversationLabel = \"Security PSIRT Analysis\") {\n            try {\n                const mermaidCode = generateSequenceDiagram(currentData, conversationLabel);\n                \n                // Clear previous diagram\n                const diagramDiv = document.getElementById('diagram');\n                diagramDiv.innerHTML = '';\n                \n                // Render new diagram\n                mermaid.render('sequence-diagram', mermaidCode)\n                    .then(result => {\n                        diagramDiv.innerHTML = result.svg;\n                    })\n                    .catch(error => {\n                        console.error('Error rendering diagram:', error);\n                        diagramDiv.innerHTML = '<p style=\"color: #ff6b6b;\">Error rendering diagram. Check console for details.</p>';\n                    });\n            } catch (error) {\n                console.error('Error generating diagram:', error);\n                document.getElementById('diagram').innerHTML = '<p style=\"color: #ff6b6b;\">Error processing data: ' + error.message + '</p>';\n            }\n        }\n\n\n\n        // Function to use custom data programmatically\n        function useCustomData(newData, conversationLabel = \"Custom Conversation\") {\n            currentData = newData;\n            generateDiagram(conversationLabel);\n        }\n\n        // Generate initial diagram\n        window.onload = function() {\n            generateDiagram(conversationLabel=\"{{conversationLabel}}\");\n        };\n    </script>\n</body>\n</html>"
      },
      {
          "name": "aiSequenceSimplified_1",
          "value": "\n{%-\n  set cfxql_query2 = \"conversationId = '\"+ conversation_id + \"' GET USER_ID,persona,message,conversationLabel,timestamp,type,llm,tool_name,tool_domain,tool_content\"\n-%}\n\n\n{%-\n    set rows = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2, sorting=[{\"timestamp\": \"asc\"}], limit=1000, max_rows=1000)\n-%}\n\n{%- set conversationLabel = \"\" -%}\n{%- if len(rows) > 0 -%}\n    {%- set conversationLabel = rows[0].get(\"conversationLabel\", \"\") -%}\n{%- endif -%}\n\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>AI Interaction Diagram - Dark Theme</title>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js\"></script>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            margin: 0;\n            padding: 10px;\n            background-color: #1a1a1a;\n            color: #e0e0e0;\n            height: 100vh;\n            box-sizing: border-box;\n        }\n        .container {\n            width: 100%;\n            height: calc(100vh - 20px);\n            background: #2d2d2d;\n            padding: 15px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n            border: 1px solid #404040;\n            box-sizing: border-box;\n            display: flex;\n            flex-direction: column;\n        }\n        h1 {\n            color: #ffffff;\n            text-align: center;\n            margin: 0 0 20px 0;\n            flex-shrink: 0;\n        }\n        .diagram-container {\n            width: 100%;\n            overflow-x: auto;\n            border: 1px solid #555;\n            border-radius: 4px;\n            padding: 15px;\n            background: #242424;\n            flex: 1;\n            min-height: 0;\n        }\n       \n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1 id=\"diagram-title\">AI Interaction Diagram</h1>\n        \n\n\n\n\n\n\n        <div class=\"diagram-container\">\n            <div id=\"diagram\"></div>\n        </div>\n    </div>\n\n    <script>\n        // Sample data from the user\n        let currentData = {{json_dumps(rows)}};\n\n        // Initialize Mermaid with dark theme\n        mermaid.initialize({ startOnLoad: false, theme: 'dark', maxTextSize: 100000, sequence: { showSequenceNumbers: true } });\n\n        function generateSequenceDiagram(data, conversationLabel = \"Default Conversation\") {\n            \n            \n            let mermaidCode = \"sequenceDiagram\\n\";\n            \n            // Update title\n            document.getElementById('diagram-title').textContent = `AI Interaction Diagram: ${conversationLabel}`;\n            \n            // Define participants based on the data\n            const userId = data[0].USER_ID || \"Client\";\n            let clientType = \"Agents\";\n            if (userId.includes(\"@\")) {\n                clientType = \"Users\";\n            };\n            const userIdShort = userId.split('@')[0]; // Get the username part for cleaner display\n            const llmName = data[0].llm || data.at(-1).llm || \"LLM\"; // Get LLM name from data\n            \n            mermaidCode += `    box rgb(80,80,200) ${clientType}\\n`;\n            mermaidCode += `    participant Client as ${userIdShort}\\n`;\n            mermaidCode += `    end\\n`;\n            mermaidCode += `    participant MCP_Client as MCP Client\\n`;\n            mermaidCode += `    box rgb(100,0,100) AI Models\\n`;\n            mermaidCode += `    participant ${llmName} as ${llmName}\\n`;\n            mermaidCode += `    end\\n`;\n            mermaidCode += `    participant MCP_Server as MCP Server\\n`;\n\n            mermaidCode += `    box rgb(30,81, 40) Tool Domains\\n`;\n            \n            // Get unique tool domains\n            const toolDomains = [...new Set(data\n                .filter(item => item.tool_domain)\n                .map(item => item.tool_domain))];\n            \n            toolDomains.forEach(domain => {\n                mermaidCode += `    participant ${domain} as ${domain}\\n`;\n            });\n\n            mermaidCode += `    end\\n`;\n            \n            mermaidCode += \"\\n\";\n            let rectToggle = false;\n            \n            // Process each data entry according to the rules\n            data.forEach((item, index) => {\n                if (item.type === \"client\") {\n                    // Rule: Draw line from client to MCP Client and then from MCP Client to LLM\n                    const persona = item.persona || \"Unknown\"\n                    const shortMessage = item.message.length > 30 \n                        ? item.message.substring(0, 30) + \"...\" \n                        : item.message;\n                    mermaidCode += `    Client->>MCP_Client: [${persona}] ${shortMessage.replace(/\\n/g, ' ')}\\n`;\n                    mermaidCode += `    MCP_Client->>+${llmName}: Forward request + System Instructions\\n\\n`;\n                    \n                } else if (item.type === \"Assistant\" && item.tool_name) {\n                    // Rule: Tool calling sequence\n                    const toolName = item.tool_name;\n                    const toolDomain = item.tool_domain;\n                    \n                   // mermaidCode += `    note left of ${llmName}: Tool Call ${toolName}\\n`;\n                    const rectColor = rectToggle ? 'rgba(120, 120, 120, 0.8)' : 'rgba(120, 120, 120, 0.8)';\n                    mermaidCode += `    rect ${rectColor}\\n`;\n                   \n                    mermaidCode += `        ${llmName}->>${toolDomain}: ${toolName}\\n`;\n                    // mermaidCode += `        MCP_Client->>MCP_Server: ${toolName}\\n`;\n                    // mermaidCode += `        MCP_Server->>${toolDomain}: ${toolName}\\n`;\n                    mermaidCode += `        ${toolDomain}->>${llmName}: ${toolName} Response\\n`;\n                   // mermaidCode += `        MCP_Server->>MCP_Client: ${toolName} Response\\n`;\n                   // mermaidCode += `        MCP_Client->>${llmName}: ${toolName} Response\\n`;\n                    mermaidCode += `    end\\n\\n`;\n\n                    rectToggle = !rectToggle;\n                    \n                } else if (item.type === \"Assistant\" && !item.tool_name) {\n                    // Rule: Response from LLM to MCP_Client and then to User with \"Response\" label\n                    mermaidCode += `    ${llmName}->>MCP_Client: Response\\n`;\n                    mermaidCode += `    MCP_Client->>Client: Response\\n`;\n                }\n            });\n            \n            return mermaidCode;\n        }\n\n        function generateDiagram(conversationLabel = \"Security PSIRT Analysis\") {\n            try {\n                const mermaidCode = generateSequenceDiagram(currentData, conversationLabel);\n                \n                // Clear previous diagram\n                const diagramDiv = document.getElementById('diagram');\n                diagramDiv.innerHTML = '';\n                \n                // Render new diagram\n                mermaid.render('sequence-diagram', mermaidCode)\n                    .then(result => {\n                        diagramDiv.innerHTML = result.svg;\n                    })\n                    .catch(error => {\n                        console.error('Error rendering diagram:', error);\n                        diagramDiv.innerHTML = '<p style=\"color: #ff6b6b;\">Error rendering diagram. Check console for details.</p>';\n                    });\n            } catch (error) {\n                console.error('Error generating diagram:', error);\n                document.getElementById('diagram').innerHTML = '<p style=\"color: #ff6b6b;\">Error processing data: ' + error.message + '</p>';\n            }\n        }\n\n\n\n        // Function to use custom data programmatically\n        function useCustomData(newData, conversationLabel = \"Custom Conversation\") {\n            currentData = newData;\n            generateDiagram(conversationLabel);\n        }\n\n        // Generate initial diagram\n        window.onload = function() {\n            generateDiagram(conversationLabel=\"{{conversationLabel}}\");\n        };\n    </script>\n</body>\n</html>"
      },
      {
          "name": "aiSequenceSimplified",
          "value": "{%- set cfxql_query2 = \"conversationId is '\"+ conversation_id + \"' or conversationId is '\"+ conversationId + \"' GET USER_ID,persona,message,conversationLabel,timestamp,type,llm,tool_name,tool_domain,tool_content\" -%}\r\n\r\n{%- set rows = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2, sorting=[{\"timestamp\": \"asc\"}], limit=1000, max_rows=1000) -%}\r\n\r\n{%- set conversationLabel = \"\" -%}\r\n{%- if len(rows) > 0 -%}\r\n    {%- set conversationLabel = rows[0].get(\"conversationLabel\", \"\") -%}\r\n{%- endif -%}\r\n\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n  <meta charset=\"utf-8\" />\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n  <title>AI Interaction Diagram - Dark Theme</title>\r\n  <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js\"></script>\r\n  <style>\r\n    body { font-family: Arial, sans-serif; margin:0; padding:10px; background:#1a1a1a; color:#e0e0e0; height:100vh; box-sizing:border-box; }\r\n    .container { width:100%; height:calc(100vh - 20px); background:#2d2d2d; padding:15px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.3); border:1px solid #404040; display:flex; flex-direction:column; }\r\n    h1 { color:#fff; text-align:center; margin:0 0 20px 0; flex-shrink:0; }\r\n    .diagram-container { width:100%; overflow-x:auto; border:1px solid #555; border-radius:4px; padding:15px; background:#242424; flex:1; min-height:0; }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <h1 id=\"diagram-title\">AI Interaction Diagram</h1>\r\n    <div class=\"diagram-container\"><div id=\"diagram\"></div></div>\r\n  </div>\r\n\r\n  <script>\r\n    // Data from Jinja\r\n    let currentData = {{ json_dumps(rows) }};\r\n\r\n    // Mermaid init\r\n    mermaid.initialize({ startOnLoad: false, theme: 'dark', maxTextSize: 100000, sequence: { showSequenceNumbers: true } });\r\n\r\n    // Extract first two parts of tool_name (proj_name-domain_name)\r\n    function extractProjDomain(toolName) {\r\n      if (!toolName) return \"Unknown\";\r\n      const parts = toolName.split(\"-\");\r\n      if (parts.length >= 2) return (parts[0] + \"-\" + parts[1]).replace(/['\"]/g, \"\");\r\n      // fallback to whole toolName (stripped of quotes)\r\n      return toolName.replace(/['\"]/g, \"\");\r\n    }\r\n\r\n    // Create a Mermaid-safe identifier (no special chars) for participant id\r\n    function safeId(name) {\r\n      // keep alnum and underscores only for IDs\r\n      return name.replace(/[^a-zA-Z0-9_]/g, \"_\");\r\n    }\r\n\r\n    // Create a display label without quotes. If it contains unsafe chars for Mermaid we normalize them\r\n    function safeDisplayLabel(name) {\r\n      // strip stray quotes\r\n      let s = name.replace(/['\"]/g, \"\");\r\n      // allow letters, numbers, underscore and hyphen in display (try to keep hyphen)\r\n      // if label still has problematic chars (spaces etc.), replace them with underscore\r\n      if (/^[A-Za-z0-9_-]+$/.test(s)) return s;\r\n      return s.replace(/[^A-Za-z0-9_-]/g, \"_\");\r\n    }\r\n\r\n    function generateSequenceDiagram(data, conversationLabel = \"Default Conversation\") {\r\n      let mermaidCode = \"sequenceDiagram\\n\";\r\n      document.getElementById('diagram-title').textContent = `AI Interaction Diagram: ${conversationLabel}`;\r\n\r\n      if (!data || data.length === 0) {\r\n        mermaidCode += \"    participant NoData as NoData\\n\";\r\n        return mermaidCode;\r\n      }\r\n\r\n      const userId = data[0].USER_ID || \"Client\";\r\n      const clientType = (userId && userId.includes(\"@\")) ? \"Users\" : \"Agents\";\r\n      const userIdShort = (userId || \"Client\").split('@')[0];\r\n      const llmName = data[0].llm || data.at(-1)?.llm || \"LLM\";\r\n\r\n      // client box + participants\r\n      mermaidCode += `    box rgb(80,80,200) ${clientType}\\n`;\r\n      mermaidCode += `    participant Client as ${userIdShort}\\n`;\r\n      mermaidCode += `    end\\n`;\r\n      mermaidCode += `    participant MCP_Client as MCP Client\\n`;\r\n      mermaidCode += `    box rgb(100,0,100) AI_Models\\n`;\r\n      mermaidCode += `    participant ${llmName} as ${llmName}\\n`;\r\n      mermaidCode += `    end\\n`;\r\n      mermaidCode += `    participant MCP_Server as MCP Server\\n\\n`;\r\n\r\n      // Build unique domains from tool_name (proj_name-domain_name)\r\n      const domains = [...new Set(\r\n        data\r\n          .filter(item => item.tool_name)\r\n          .map(item => extractProjDomain(item.tool_name))\r\n      )];\r\n\r\n      if (domains.length > 0) {\r\n        mermaidCode += `    box rgb(30,81,40) Tool_Domains\\n`;\r\n        domains.forEach(domain => {\r\n          const display = safeDisplayLabel(domain);  // display text (no quotes)\r\n          const id = safeId(display);               // safe participant id\r\n          // NOTE: no surrounding quotes added \u2014 you requested no quotes on top labels\r\n          mermaidCode += `    participant ${id} as ${display}\\n`;\r\n        });\r\n        mermaidCode += `    end\\n\\n`;\r\n      }\r\n\r\n      let rectToggle = false;\r\n\r\n      // iterate rows and draw sequence\r\n      data.forEach(item => {\r\n        if (item.type === \"client\") {\r\n          const persona = item.persona || \"Unknown\";\r\n          const msg = (item.message || \"\").replace(/\\n/g, \" \");\r\n          const shortMessage = msg.length > 30 ? msg.substring(0,30) + \"...\" : msg;\r\n          mermaidCode += `    Client->>MCP_Client: [${persona}] ${shortMessage}\\n`;\r\n          mermaidCode += `    MCP_Client->>+${llmName}: Forward request + System Instructions\\n\\n`;\r\n        }\r\n        else if ((item.type === \"Assistant\" || item.type === \"openai\") && item.tool_name) {\r\n          const rawDomain = extractProjDomain(item.tool_name);\r\n          const displayDomain = safeDisplayLabel(rawDomain); // matches what we used above\r\n          const domainId = safeId(displayDomain);\r\n          const toolName = item.tool_name || \"tool\";\r\n          const rectColor = rectToggle ? 'rgba(120,120,120,0.6)' : 'rgba(100,100,100,0.6)';\r\n          mermaidCode += `    rect ${rectColor}\\n`;\r\n          mermaidCode += `        ${llmName}->>${domainId}: ${toolName}\\n`;\r\n          mermaidCode += `        ${domainId}->>${llmName}: ${toolName} Response\\n`;\r\n          mermaidCode += `    end\\n\\n`;\r\n          rectToggle = !rectToggle;\r\n        }\r\n        else if ((item.type === \"Assistant\" || item.type === \"openai\") && !item.tool_name) {\r\n          mermaidCode += `    ${llmName}->>MCP_Client: Response\\n`;\r\n          mermaidCode += `    MCP_Client->>Client: Response\\n`;\r\n        }\r\n      });\r\n\r\n      return mermaidCode;\r\n    }\r\n\r\n    function generateDiagram(conversationLabel = \"Conversation\") {\r\n      try {\r\n        const mermaidCode = generateSequenceDiagram(currentData, conversationLabel);\r\n        console.log(\"Generated Mermaid code:\\n\", mermaidCode); // helpful for debugging\r\n        const diagramDiv = document.getElementById('diagram');\r\n        diagramDiv.innerHTML = '';\r\n        mermaid.render('sequence-diagram', mermaidCode)\r\n          .then(result => { diagramDiv.innerHTML = result.svg; })\r\n          .catch(err => {\r\n            console.error(\"Mermaid render error:\", err);\r\n            diagramDiv.innerHTML = \"<p style='color:#ff6b6b;'>Error rendering diagram \u2014 check console.</p>\";\r\n          });\r\n      } catch (err) {\r\n        console.error(\"Error generating diagram:\", err);\r\n        document.getElementById('diagram').innerHTML = \"<p style='color:#ff6b6b;'>Error: \" + err.message + \"</p>\";\r\n      }\r\n    }\r\n\r\n    // render on load\r\n    window.onload = function() {\r\n      generateDiagram(\"{{conversationLabel}}\");\r\n    };\r\n  </script>\r\n</body>\r\n</html>\r\n"
      },
      {
          "name": "aiSequenceMonoColor",
          "value": "{%- set cfxql_query2 = \"conversationId = '\"+ conversation_id + \"' GET USER_ID,persona,message,conversationLabel,timestamp,type,llm,tool_name,tool_domain,tool_content\" -%}\r\n\r\n{%- set rows = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2, sorting=[{\"timestamp\": \"asc\"}], limit=1000, max_rows=1000) -%}\r\n\r\n{%- set conversationLabel = \"\" -%}\r\n{%- if len(rows) > 0 -%}\r\n    {%- set conversationLabel = rows[0].get(\"conversationLabel\", \"\") -%}\r\n{%- endif -%}\r\n\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>AI Interaction Diagram - Dark Theme</title>\r\n  <script src=\"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js\"></script>\r\n  <style>\r\n    body { font-family: Arial, sans-serif; margin:0; padding:10px; background:#1a1a1a; color:#e0e0e0; height:100vh; box-sizing:border-box; }\r\n    .container { width:100%; height:calc(100vh - 20px); background:#2d2d2d; padding:15px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.3); border:1px solid #404040; display:flex; flex-direction:column; }\r\n    h1 { color:#fff; text-align:center; margin:0 0 20px 0; flex-shrink:0; }\r\n    .diagram-container { width:100%; overflow-x:auto; border:1px solid #555; border-radius:4px; padding:15px; background:#242424; flex:1; min-height:0; }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <h1 id=\"diagram-title\">AI Interaction Diagram</h1>\r\n    <div class=\"diagram-container\"><div id=\"diagram\"></div></div>\r\n  </div>\r\n\r\n  <script>\r\n    let currentData = {{ json_dumps(rows) }};\r\n\r\n    mermaid.initialize({ startOnLoad: false, theme: 'dark', maxTextSize: 100000, sequence: { showSequenceNumbers: true } });\r\n\r\n    // Extract first two parts of tool_name (proj_name-domain_name)\r\n    function extractProjDomain(toolName) {\r\n      if (!toolName) return \"Unknown\";\r\n      const parts = toolName.split(\"-\");\r\n      return (parts.length >= 2 ? parts[0] + \"-\" + parts[1] : toolName).replace(/['\"]/g, \"\");\r\n    }\r\n\r\n    // Safe ID for Mermaid participants\r\n    function safeId(name) {\r\n      return name.replace(/[^a-zA-Z0-9_]/g, \"_\");\r\n    }\r\n\r\n    // Safe display label (no quotes)\r\n    function safeDisplayLabel(name) {\r\n      return name.replace(/['\"]/g, \"\").replace(/[^A-Za-z0-9_-]/g, \"_\");\r\n    }\r\n\r\n    function generateSequenceDiagram(data, conversationLabel = \"Default Conversation\") {\r\n      let mermaidCode = \"sequenceDiagram\\n\";\r\n      document.getElementById('diagram-title').textContent = `AI Interaction Diagram: ${conversationLabel}`;\r\n\r\n      if (!data || data.length === 0) {\r\n        mermaidCode += \"    participant NoData as NoData\\n\";\r\n        return mermaidCode;\r\n      }\r\n\r\n      const userId = data[0].USER_ID || \"Client\";\r\n      const clientType = (userId && userId.includes(\"@\")) ? \"Users\" : \"Agents\";\r\n      const userIdShort = userId.split('@')[0];\r\n      const llmName = data[0].llm || data.at(-1)?.llm || \"LLM\";\r\n\r\n      // client box + participants\r\n      mermaidCode += `    box rgb(80,80,200) ${clientType}\\n`;\r\n      mermaidCode += `    participant Client as ${userIdShort}\\n`;\r\n      mermaidCode += `    end\\n`;\r\n      mermaidCode += `    participant MCP_Client as MCP Client\\n`;\r\n      mermaidCode += `    box rgb(100,0,100) AI_Models\\n`;\r\n      mermaidCode += `    participant ${llmName} as ${llmName}\\n`;\r\n      mermaidCode += `    end\\n`;\r\n      mermaidCode += `    participant MCP_Server as MCP Server\\n\\n`;\r\n\r\n      // Build unique domains from tool_name\r\n      const domains = [...new Set(\r\n        data.filter(item => item.tool_name).map(item => extractProjDomain(item.tool_name))\r\n      )];\r\n\r\n      if (domains.length > 0) {\r\n        mermaidCode += `    box rgb(30,81,40) Tool_Domains\\n`;\r\n        domains.forEach(domain => {\r\n          const display = safeDisplayLabel(domain);\r\n          const id = safeId(display);\r\n          mermaidCode += `    participant ${id} as ${display}\\n`;\r\n        });\r\n        mermaidCode += `    end\\n\\n`;\r\n      }\r\n\r\n      let rectToggle = false;\r\n\r\n      data.forEach(item => {\r\n        if (item.type === \"client\") {\r\n          const persona = item.persona || \"Unknown\";\r\n          const msg = (item.message || \"\").replace(/\\n/g, \" \");\r\n          const shortMessage = msg.length > 30 ? msg.substring(0,30) + \"...\" : msg;\r\n          mermaidCode += `    Client->>MCP_Client: [${persona}] ${shortMessage}\\n`;\r\n          mermaidCode += `    MCP_Client->>+${llmName}: Forward request + System Instructions\\n\\n`;\r\n        }\r\n        else if ((item.type === \"Assistant\" || item.type === \"openai\") && item.tool_name) {\r\n          const rawDomain = extractProjDomain(item.tool_name);\r\n          const displayDomain = safeDisplayLabel(rawDomain);\r\n          const domainId = safeId(displayDomain);\r\n          const toolName = item.tool_name || \"tool\";\r\n          const rectColor = rectToggle ? 'rgba(120,120,120,0.6)' : 'rgba(100,100,100,0.6)';\r\n\r\n          mermaidCode += `    rect ${rectColor}\\n`;\r\n          mermaidCode += `        ${llmName}->>MCP_Server: ${toolName}\\n`;\r\n          mermaidCode += `        MCP_Server->>${domainId}: ${toolName}\\n`;\r\n          mermaidCode += `        ${domainId}->>MCP_Server: ${toolName} Response\\n`;\r\n          mermaidCode += `        MCP_Server->>${llmName}: ${toolName} Response\\n`;\r\n          mermaidCode += `    end\\n\\n`;\r\n\r\n          rectToggle = !rectToggle;\r\n        }\r\n        else if ((item.type === \"Assistant\" || item.type === \"openai\") && !item.tool_name) {\r\n          mermaidCode += `    ${llmName}->>MCP_Client: Response\\n`;\r\n          mermaidCode += `    MCP_Client->>Client: Response\\n`;\r\n        }\r\n      });\r\n\r\n      return mermaidCode;\r\n    }\r\n\r\n    function generateDiagram(conversationLabel = \"Conversation\") {\r\n      try {\r\n        const mermaidCode = generateSequenceDiagram(currentData, conversationLabel);\r\n        const diagramDiv = document.getElementById('diagram');\r\n        diagramDiv.innerHTML = '';\r\n        mermaid.render('sequence-diagram', mermaidCode)\r\n          .then(result => { diagramDiv.innerHTML = result.svg; })\r\n          .catch(err => {\r\n            console.error(\"Mermaid render error:\", err);\r\n            diagramDiv.innerHTML = \"<p style='color:#ff6b6b;'>Error rendering diagram \u2014 check console.</p>\";\r\n          });\r\n      } catch (err) {\r\n        console.error(\"Error generating diagram:\", err);\r\n        document.getElementById('diagram').innerHTML = \"<p style='color:#ff6b6b;'>Error: \" + err.message + \"</p>\";\r\n      }\r\n    }\r\n\r\n    window.onload = function() {\r\n      generateDiagram(\"{{conversationLabel}}\");\r\n    };\r\n  </script>\r\n</body>\r\n</html>\r\n"
      }
  ]
}