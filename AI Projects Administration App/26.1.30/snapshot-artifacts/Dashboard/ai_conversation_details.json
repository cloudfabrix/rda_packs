{
  "name": "ai_conversation_details",
  "description": "AI Conversation Details",
  "label": "AI Conversation Detailss",
  "enabled": true,
  "dashboard_folder": "AI",
  "dashboard_style": "auto",
  "dashboard_type": "template",
  "template_variables": {
      "CONVERSATION_ID": {
          "contextId": "conversationId",
          "default": "2cf24a24-f406-452f-be9f-998697f490ba",
          "default1": "a647971b-62a8-4072-ed69-505f9c0a9e14"
      },
      "TOOL_NAME": {
          "contextId": "tool_name",
          "default": ""
      },
      "TOOL_DOMAIN": {
          "contextId": "domain",
          "default": ""
      }
  },
  "live_edit": true,
  "dashboard_sections": [
      {
          "title": "AI Conversation Details",
          "show_filter": false,
          "widgets": [
              {
                  "widget_type": "label",
                  "label": "attachment://ai_costs",
                  "widget_id": "eac56026",
                  "fixed_variables": {
                      "conversation_id": "{{CONVERSATION_ID}}",
                      "tool_name": "{{TOOL_NAME}}",
                      "domain": "{{TOOL_DOMAIN}}"
                  },
                  "uses_reporting_engine": true,
                  "advanced": false
              }
          ]
      }
  ],
  "saved_time": "2025-12-05T12:29:37.336914",
  "attachments": [
      {
          "name": "ai_costs_05_12",
          "value": "{% raw %}\r\n<div style=\"overflow: auto; width: 100%; height: 100%; background-color: #000000; color: #ffffff; padding: 10px 10px 0px 20px;\">\r\n\r\n{% set llm_cost_query = ' * GET llm_name, input_token_cost_per1M, output_token_cost_per1M' %}\r\n{% set llm_costs = engine.query_stream_data(\r\n    \"llm_model_costs\",\r\n    cfxql_query=llm_cost_query,\r\n    sorting=[{\"llm_name\": \"asc\"}],\r\n    limit=100,\r\n    max_rows=100\r\n) %}\r\n{% set costs = {} %}\r\n{% for cost_row in llm_costs %}\r\n    {% set _ = costs.update({\r\n        cost_row.llm_name: [\r\n            cost_row.input_token_cost_per1M | float,\r\n            cost_row.output_token_cost_per1M | float\r\n        ]\r\n    }) %}\r\n{% endfor %}\r\n\r\n{%- set cfxql_query2 = \"conversationId = '\"+ conversation_id + \"' GET USER_ID,persona,message,conversationLabel,timestamp,type,llm,tool_name,token_usage_input_tokens,token_usage_cache_tokens,token_usage_output_tokens,tool_content,codeBlocks\" -%}\r\n\r\n{%- set convs = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2, sorting=[{\"timestamp\": \"asc\"}], limit=1000, max_rows=1000) -%}\r\n\r\n{%- set ns = namespace(prompts=0, lasttime=\"\", input=0, output=0, cache=0, cost=0) -%}\r\n{%- if convs -%}\r\n    {%- set st = to_datetime(convs[0][\"timestamp\"]) -%}\r\n    {%- set et = to_datetime(convs[-1][\"timestamp\"]) -%}\r\n\r\n    {%- set convMap = {\r\n        \"USER_ID\": convs[0][\"USER_ID\"],\r\n        \"persona\": convs[0][\"persona\"],\r\n        \"conversationLabel\": convs[0][\"conversationLabel\"],\r\n        \"duration\": str((et-st).to_pytimedelta()).split(\".\")[0],\r\n        \"toolCount\": 0,\r\n        \"prompts\": 0,\r\n        \"cost\": \"\"\r\n      }\r\n    -%}\r\n    {%- for c in convs -%}\r\n      {%- set ns.input = ns.input + c.get(\"token_usage_input_tokens\",0) -%}\r\n      {%- set ns.output = ns.output + c.get(\"token_usage_output_tokens\",0) -%}\r\n      {%- set ns.cache = ns.cache + c.get(\"token_usage_cache_tokens\",0) -%}\r\n      {%- if costs.get(c.get(\"llm\", \"unknown\")) -%}\r\n        {%- set cm = costs.get(c.get(\"llm\", \"\"), [0, 0]) -%}\r\n        {%- set ns.cost = ns.cost + cm[0] *  c.get(\"token_usage_input_tokens\",0)/1000000.0 + cm[1]*c.get(\"token_usage_output_tokens\",0)/1000000.0 -%}\r\n      {%- endif -%}\r\n    {%- endfor -%}\r\n    {%- set ns.cost = ns.cost | round (4) -%}\r\n\r\n    <table width='90%' border=0 cellspacing=5 cellpadding=0>\r\n    <tr>\r\n        <td style='text-align: center; vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/customer.svg' style=\"width: 15px; height: auto; min-height: 10px; margin-right: 5px;\">\r\n            <span>User</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/collaboration.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Conversation Label</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/insights.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Persona</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/schedule.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Duration</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/nextSteps.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Tokens</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/status.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Estimated Cost</span>\r\n          </div>\r\n        </td>\r\n    </tr>\r\n    <tr>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>{{convMap[\"USER_ID\"]}}</div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle;font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>{{convMap[\"conversationLabel\"]}}</div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle;font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>{{convMap[\"persona\"]}}</div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>{{convMap[\"duration\"]}}</div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 12px; font-weight: bold;'>\r\n          <div style='padding-left: 5px; text-align: center; '>\r\n            <center>\r\n              <table border=0 cellspacing=5 cellpadding=1>\r\n                <tr>\r\n                  <td  style=\"text-align: center; border-bottom: 1px solid grey; \">Input</td>\r\n                  <td  style=\"text-align: center;  border-bottom: 1px solid grey; \">Cache</td>\r\n                  <td   style=\"text-align: center;  border-bottom: 1px solid grey; \">Output</td>\r\n                </tr>\r\n                <tr>\r\n                  <td  style=\"text-align: center; \">{{\"{:,}\".format(ns.input)}}</td>\r\n                  <td  style=\"text-align: center; \">{{\"{:,}\".format(ns.cache)}}</td>\r\n                  <td  style=\"text-align: center; \">{{\"{:,}\".format(ns.output)}}</td>\r\n                </tr>\r\n              </table>\r\n            </center>\r\n          </div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>$ {{ns.cost}}</div>\r\n        </td>\r\n    </tr>\r\n    </table>\r\n\r\n    {%- for c in convs -%}\r\n      {%- set ns.input = ns.input + c.get(\"token_usage_input_tokens\",0) -%}\r\n      {%- set ns.output = ns.input + c.get(\"token_usage_output_tokens\",0) -%}\r\n      {%- set ns.cache = ns.cache + c.get(\"token_usage_cache_tokens\",0) -%}\r\n\r\n      {%- set cache_tokens = 0 -%}\r\n      {%- if c.get(\"token_usage_cache_tokens\",0) -%}\r\n          {%- set cache_tokens = c.get(\"token_usage_cache_tokens\",0) -%}\r\n      {%- endif -%}\r\n      <div style='height: 10px;'></div>\r\n\r\n       {%- if c[\"type\"] == \"client\" -%}\r\n          <hr></hr>\r\n\r\n          {%- set ns.prompts = ns.prompts + 1 -%}\r\n          <div style=\"display: flex; align-items: center; margin-top: 5px; color: #888888;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/customer.svg' style=\"margin-right: 5px; width: 15px; height: auto;\">\r\n            <span> {{c[\"timestamp\"]}} <font color='#ffffff'>[<b>{{c[\"USER_ID\"]}}</b>] {{c[\"message\"]}} </font></span>\r\n          </div>\r\n          {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n\r\n       {%- elif c.get(\"tool_name\") -%}\r\n          {%- set highlighted = \"\" -%}\r\n          {%- if tool_name and tool_name == c[\"tool_name\"] -%}\r\n              {%- set highlighted = \"<font color='#00ffff' size=4><b> &check;&check; </b></font>\" -%}\r\n          {%- elif domain and c[\"tool_name\"].startswith(domain) -%}\r\n              {%- set highlighted = \"<font color='#00ffff' size=4><b> &check; </b></font>\" -%}\r\n          {%- endif -%}\r\n          {%- set td = str((to_datetime(c[\"timestamp\"])-ns.lasttime).to_pytimedelta()).split(\".\")[0] -%}\r\n          {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n          <div style='padding: 0px 0px 0px 20px; color: #888888;'>\r\n            <details>\r\n              <summary>\r\n                + {{td}} <font color='#ffff00'>[<b>{{c[\"llm\"]}}</b>] Tool Call: {{c[\"tool_name\"]}} </font>\r\n                (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }},\r\n                 Output:  {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }},\r\n                 Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }})\r\n                {{highlighted}}\r\n              </summary>\r\n              <div style=\"overflow: auto; width: 100%; height: 200px; padding: 5px 5px 5px 5px; border-left: 1px solid #ffff00; border-top: 0px solid #ffff00; border-right: 0px solid #ffff00; border-bottom: 0px solid #ffff00;\">\r\n\r\n                {# Safely handle missing / empty codeBlocks #}\r\n                {%- set raw_code = c.get(\"codeBlocks\") -%}\r\n                {% if raw_code %}\r\n                  <pre>{{ raw_code.strip('{}').split(\":\", 1)[1] | trim | trim('\"') | replace('\\\\n', '\\n') | replace('\\\\\"', '\"') }}</pre>\r\n                {% else %}\r\n                  <pre>No codeBlocks available for this tool call.</pre>\r\n                {% endif %}\r\n\r\n              </div>\r\n            </details>\r\n          </div>\r\n\r\n       {%- else  -%}\r\n          {%- set td = str((to_datetime(c[\"timestamp\"])-ns.lasttime).to_pytimedelta()).split(\".\")[0] -%}\r\n          {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n          <div style=\"display: flex; align-items: center; margin-top: 5px; color: #888888;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/nlp.svg' style=\"margin-right: 5px; width: 15px; height: auto;\">\r\n            <details>\r\n              <summary>\r\n                + {{td}} <span style='color: #ff00ff;'>[<b>{{c[\"llm\"]}}</b>] Response </span>\r\n                (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }},\r\n                 Output: {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }},\r\n                 Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }})\r\n              </summary>\r\n              <div style=\"overflow: auto; width: 90%; height: 200px; padding: 5px 5px 5px 5px; border-left: 1px solid #ff00ff; \">\r\n                {{c[\"message\"]}}\r\n              </div>\r\n            </details>\r\n          </div>\r\n       {%- endif  -%}\r\n\r\n    {%- endfor -%}\r\n\r\n{%- else -%}\r\n   <b>Conversation with ID {{conversation_id}} not found. May have been purged from the stream</b>\r\n{%- endif -%}\r\n\r\n</div>\r\n{% endraw %}\r\n"
      },
      {
          "name": "Attachment 1",
          "value": "\n\n{%-\n  set cfxql_query1 = \"timestamp is after -24hours\"\n-%}\n\n{%-\n  set cfxql_query2 = \"timestamp is after -24hours and type = 'client' GET USER_ID,conversationId,message\"\n-%}\n\n{%-\n  set aggs = [ {\n        \"func\": \"sum\",\n        \"field\": \"token_usage_input_tokens\",\n        \"label\": \"input\"\n    },{\n        \"func\": \"sum\",\n        \"field\": \"token_usage_output_tokens\",\n        \"label\": \"output\"\n    }\n    ]\n-%}\n\n{%-\n    set tokens = engine.query_stream_aggs(stream=\"rda_chat_sessions\", cfxql_query=cfxql_query1, aggs=aggs, groupby=[\"conversationId\", \"llm\"])\n-%}\n\n{%-\n    set convs = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2)\n-%}\n\n{%-\n  set convMap = {}\n-%}\n\n{%-\n    for c in convs\n-%}\n{%- \n  set _ = convMap.update({\n        c[\"conversationId\"]: {\n            \"conversationId\": c[\"conversationId\"],\n            \"prompt\": c[\"message\"],\n            \"USER_ID\": c[\"USER_ID\"],\n            \"input_cost\": 0,\n            \"ouput_cost\": 0\n        }\n  })\n-%}\n\n{%-\n    endfor\n-%}\n\n{%-\n set costs = {\n    \"O3-mini\": [1.1, 4.4],\n    \"gpt-4o\": [ 2.5, 10],\n    \"gpt-4.1\": [2, 8],\n    \"gpt-4.1-mini\": [0.4, 1.6],\n    \"claude-sonnet-4\": [3, 15],\n    \"claude-haiku-3.5\": [0.8, 4]\n }\n\n-%}\n\n{{tokens}}\n<div>\n<table border=1><tr><th>Timestamp</th><th>User ID</th><th>Persona</th><th>Prompt</th><th>Input Cost</th><th>Output Cost</th><Total Cost</th><th> Conv. ID</th></tr>\n\n{%-\n    for c in convMap.values()\n-%}\n<tr>\n  <td>{{c[\"timestamp\"]}}</td>\n  <td>{{c[\"USER_ID\"]}}</td>\n  <td>{{c[\"prompt\"]}}</td>\n  <td>${{round(c[\"input_cost\"],4)}}</td>\n  <td>${{round(c[\"output_cost\"],4)}}</td>\n  <td>${{round(c[\"input_cost\"]+c[\"output_cost\"],4)}}</td>\n  <td>{{c[\"conversationId\"]}}</td>\n\n</tr>\n{%-\n    endfor\n-%}\n</table>\n</div>\n"
      },
      {
          "name": "ai_cost_old",
          "value": "{%raw%}\r\n<div style=\"overflow: auto; width: 100%; height: 100%; background-color: #000000; color: #ffffff; padding: 10px 10px 0px 20px;\">\r\n\r\n{% set llm_cost_query = ' * GET llm_name, input_token_cost_per1M, output_token_cost_per1M' %}\r\n{% set llm_costs = engine.query_stream_data(\r\n    \"llm_model_costs\",\r\n    cfxql_query=llm_cost_query,\r\n    sorting=[{\"llm_name\": \"asc\"}],\r\n    limit=100,\r\n    max_rows=100\r\n) %}\r\n{% set costs = {} %}\r\n{% for cost_row in llm_costs %}\r\n    {% set _ = costs.update({\r\n        cost_row.llm_name: [\r\n            cost_row.input_token_cost_per1M | float, \r\n            cost_row.output_token_cost_per1M | float\r\n        ]\r\n    }) %}\r\n{% endfor %}\r\n{%-\r\n  set cfxql_query2 = \"conversationId = '\"+ conversation_id + \"' GET USER_ID,persona,message,conversationLabel,timestamp,type,llm,tool_name,token_usage_input_tokens,token_usage_cache_tokens,token_usage_output_tokens,tool_content,codeBlocks\"\r\n-%}\r\n\r\n\r\n{%-\r\n    set convs = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2, sorting=[{\"timestamp\": \"asc\"}], limit=1000, max_rows=1000)\r\n-%}\r\n\r\n\r\n{%- set ns = namespace(prompts=0, lasttime=\"\", input=0, output=0, cache=0, cost=0) -%}\r\n{%-if convs -%}\r\n    {%- set st = to_datetime(convs[0][\"timestamp\"]) -%}\r\n    {%- set et = to_datetime(convs[-1][\"timestamp\"]) -%}\r\n\r\n    {%-\r\n      set convMap = {\r\n        \"USER_ID\": convs[0][\"USER_ID\"],\r\n        \"persona\": convs[0][\"persona\"],\r\n        \"conversationLabel\": convs[0][\"conversationLabel\"],\r\n        \"duration\": str((et-st).to_pytimedelta()).split(\".\")[0],\r\n        \"toolCount\": 0,\r\n        \"prompts\": 0,\r\n        \"cost\": \"\"\r\n      }\r\n    -%}\r\n    {%- for c in convs -%}\r\n      {%- set ns.input = ns.input + c.get(\"token_usage_input_tokens\",0) -%}\r\n      {%- set ns.output = ns.output + c.get(\"token_usage_output_tokens\",0) -%}\r\n      {%- set ns.cache = ns.cache + c.get(\"token_usage_cache_tokens\",0) -%}\r\n{%- if costs.get(c.get(\"llm\", \"unknown\")) -%}\r\n    {%- set cm = costs.get(c.get(\"llm\", \"\"), [0, 0]) -%}\r\n          {%- set ns.cost = ns.cost + cm[0] *  c.get(\"token_usage_input_tokens\",0)/1000000.0 + cm[1]*c.get(\"token_usage_output_tokens\",0)/1000000.0-%}\r\n      {%- endif -%}\r\n    {%- endfor -%}\r\n    {%- set ns.cost = ns.cost | round (4) -%}\r\n    <table width='90%' border=0 cellspacing=5 cellpadding=0>\r\n    <tr>\r\n        <td style='text-align: center; vertical-align: middle;' > <div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/customer.svg' style=\"width: 15px; height: auto; min-height: 10px; margin-right: 5px;\"><span>User</span></div></td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/collaboration.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Conversation Label</span></div></td>\r\n\r\n        <td style='text-align: center;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/insights.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Persona</span></div></td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/schedule.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Duration</span></div></td>\r\n\r\n       <td style='text-align: center;  vertical-align: middle;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/nextSteps.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Tokens</span></div></td>\r\n\r\n       <td style='text-align: center;  vertical-align: middle;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/status.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Estimated Cost</span></div></td>\r\n    </tr>\r\n    <tr>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>{{convMap[\"USER_ID\"]}}</div></td>\r\n        <td style='text-align: center;  vertical-align: middle;font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>{{convMap[\"conversationLabel\"]}}</div></td>\r\n        <td style='text-align: center;  vertical-align: middle;font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>{{convMap[\"persona\"]}}</div></td>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>{{convMap[\"duration\"]}}</div></td>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 12px; font-weight: bold;'><div style='padding-left: 5px; text-align: center; '>\r\n          <center>\r\n          <table border=0 cellspacing=5 cellpadding=1>\r\n          <tr><td  style=\"text-align: center; border-bottom: 1px solid grey; \">Input</td><td  style=\"text-align: center;  border-bottom: 1px solid grey; \">Cache</td><td   style=\"text-align: center;  border-bottom: 1px solid grey; \">Output</td></tr>\r\n          <tr><td  style=\"text-align: center; \">{{\"{:,}\".format(ns.input)}}</td><td  style=\"text-align: center; \">{{\"{:,}\".format(ns.cache)}}</td><td  style=\"text-align: center; \">{{\"{:,}\".format(ns.output)}}</td></tr>\r\n          </table>\r\n          </center>\r\n          </div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>$ {{ns.cost}}</div></td>\r\n    </tr>\r\n    </table>\r\n   \r\n    {%- for c in convs -%}\r\n      {%- set ns.input = ns.input + c.get(\"token_usage_input_tokens\",0) -%}\r\n      {%- set ns.output = ns.input + c.get(\"token_usage_output_tokens\",0) -%}\r\n      {%- set ns.cache = ns.cache + c.get(\"token_usage_cache_tokens\",0) -%}\r\n\r\n\r\n      {%- set cache_tokens = 0 -%}\r\n      {%- if c.get(\"token_usage_cache_tokens\",0) -%}\r\n          {%-  set cache_tokens = c.get(\"token_usage_cache_tokens\",0)  -%}\r\n      {%- endif -%}\r\n      <div style='height: 10px;'></div>\r\n       \r\n       {%- if c[\"type\"] == \"client\" -%}\r\n          <hr></hr>\r\n\r\n          {%- set ns.prompts = ns.prompts + 1 -%}\r\n          <div style=\"display: flex; align-items: center; margin-top: 5px; color: #888888;\">\r\n          <img src='/assets/img/icons/featureApp/svgIcons/customer.svg' style=\"margin-right: 5px; width: 15px; height: auto;\"> <span> {{c[\"timestamp\"]}} <font color='#ffffff'>[<b>{{c[\"USER_ID\"]}}</b>] {{c[\"message\"]}} </font></span>\r\n          </div>\r\n         {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n       {%- elif c[\"tool_name\"] -%}\r\n          {%- set highlighted = \"\" -%}\r\n          {%- if tool_name and tool_name == c[\"tool_name\"] -%}\r\n              {%- set highlighted = \"<font color='#00ffff' size=4><b> &check;&check; </b></font>\" -%}\r\n          {%- elif domain and c[\"tool_name\"].startswith(domain) -%}\r\n              {%- set highlighted = \"<font color='#00ffff' size=4><b> &check; </b></font>\" -%}\r\n          {%- endif -%}\r\n          {%- set td = str((to_datetime(c[\"timestamp\"])-ns.lasttime).to_pytimedelta())[:-5] -%}\r\n          {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n           <div style='padding: 0px 0px 0px 20px; color: #888888;'>\r\n           <details><summary> + {{td}} <font color='#ffff00'>[<b>{{c[\"llm\"]}}</b>] Tool Call: {{c[\"tool_name\"]}} </font> (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }}, Output:  {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }}, Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }}) {{highlighted}} </summary>\r\n         <div style=\"overflow: auto; width: 100%; height: 200px; padding: 5px 5px 5px 5px; border-left: 1px solid #ffff00; border-top: 0px solid #ffff00; border-right: 0px solid #ffff00; border-bottom: 0px solid #ffff00;\">\r\n          <pre>{{ c[\"codeBlocks\"].strip('{}').split(\":\", 1)[1] | trim | trim('\"') | replace('\\\\n', '\\n') | replace('\\\\\"', '\"') }}</pre>\r\n          </div>\r\n          </details>\r\n          </div>\r\n       {%- else  -%}   \r\n        {%- set td = str((to_datetime(c[\"timestamp\"])-ns.lasttime).to_pytimedelta())[:-5] -%}\r\n          {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n           <div style=\"display: flex; align-items: center; margin-top: 5px; color: #888888;\">\r\n          <img src='/assets/img/icons/featureApp/svgIcons/nlp.svg' style=\"margin-right: 5px; width: 15px; height: auto;\">\r\n           <details><summary>+ {{td}} <span style='color: #ff00ff;'>[<b>{{c[\"llm\"]}}</b>] Response </span> (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }}, Output: {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }}, Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }}) </summary>\r\n         <div style=\"overflow: auto; width: 90%; height: 200px; padding: 5px 5px 5px 5px; border-left: 1px solid #ff00ff; \">\r\n          {{c[\"message\"]}}\r\n          </div>\r\n          </details>\r\n          </div>\r\n       {%- endif  -%}\r\n\r\n    {%- endfor -%}\r\n\r\n{%-else -%}\r\n   <b>Converation with ID {{conversation_id}} not found. May have been purged from the stream</b>\r\n{%- endif -%}\r\n\r\n\r\n\r\n</div>\r\n\r\n\r\n\r\n{%endraw%}"
      },
      {
          "name": "ai_costs_debug",
          "value": "{%raw%}\n<div style=\"overflow: auto; width: 100%; height: 100%; background-color: #000000; color: #ffffff; padding: 10px 10px 0px 20px;\">\n\n{% set llm_cost_query = ' * GET llm_name, input_token_cost_per1M, output_token_cost_per1M' %}\n{% set llm_costs = engine.query_stream_data(\n    \"llm_model_costs\",\n    cfxql_query=llm_cost_query,\n    sorting=[{\"llm_name\": \"asc\"}],\n    limit=100,\n    max_rows=100\n) %}\n{% set costs = {} %}\n{% for cost_row in llm_costs %}\n    {% set _ = costs.update({\n        cost_row.llm_name: [\n            cost_row.input_token_cost_per1M | float, \n            cost_row.output_token_cost_per1M | float\n        ]\n    }) %}\n{% endfor %}\n{%-\n  set cfxql_query2 = \"conversationId = '\"+ conversation_id + \"' GET USER_ID,persona,message,conversationLabel,timestamp,type,llm,tool_name,token_usage_input_tokens,token_usage_cache_tokens,token_usage_output_tokens,tool_content,codeBlocks\"\n-%}\n\n\n{%-\n    set convs = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2, sorting=[{\"timestamp\": \"asc\"}], limit=1000, max_rows=1000)\n-%}\n\n\n{%- set ns = namespace(prompts=0, lasttime=\"\", input=0, output=0, cache=0, cost=0) -%}\n{%-if convs -%}\n    {%- set st = to_datetime(convs[0][\"timestamp\"]) -%}\n    {%- set et = to_datetime(convs[-1][\"timestamp\"]) -%}\n\n    {%-\n      set convMap = {\n        \"USER_ID\": convs[0][\"USER_ID\"],\n        \"persona\": convs[0][\"persona\"],\n        \"conversationLabel\": convs[0][\"conversationLabel\"],\n        \"duration\": str((et-st).to_pytimedelta()).split(\".\")[0],\n        \"toolCount\": 0,\n        \"prompts\": 0,\n        \"cost\": \"\"\n      }\n    -%}\n    {%- for c in convs -%}\n      {%- set ns.input = ns.input + c.get(\"token_usage_input_tokens\",0) -%}\n      {%- set ns.output = ns.output + c.get(\"token_usage_output_tokens\",0) -%}\n      {%- set ns.cache = ns.cache + c.get(\"token_usage_cache_tokens\",0) -%}\n{%- if costs.get(c.get(\"llm\", \"unknown\")) -%}\n    {%- set cm = costs.get(c.get(\"llm\", \"\"), [0, 0]) -%}\n          {%- set ns.cost = ns.cost + cm[0] *  c.get(\"token_usage_input_tokens\",0)/1000000.0 + cm[1]*c.get(\"token_usage_output_tokens\",0)/1000000.0-%}\n      {%- endif -%}\n    {%- endfor -%}\n    {%- set ns.cost = ns.cost | round (4) -%}\n    <table width='90%' border=0 cellspacing=5 cellpadding=0>\n    <tr>\n        <td style='text-align: center; vertical-align: middle;' > <div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/customer.svg' style=\"width: 15px; height: auto; min-height: 10px; margin-right: 5px;\"><span>User</span></div></td>\n\n        <td style='text-align: center;  vertical-align: middle;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/collaboration.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Conversation Label</span></div></td>\n\n        <td style='text-align: center;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/insights.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Persona</span></div></td>\n\n        <td style='text-align: center;  vertical-align: middle;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/schedule.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Duration</span></div></td>\n\n       <td style='text-align: center;  vertical-align: middle;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/nextSteps.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Tokens</span></div></td>\n\n       <td style='text-align: center;  vertical-align: middle;' ><div style=\"display: inline-block; align-items: center;\"><img src='/assets/img/icons/featureApp/svgIcons/status.svg' style=\"width: 15px; height: auto; margin-right: 5px;\"><span>Estimated Cost</span></div></td>\n    </tr>\n    <tr>\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>{{convMap[\"USER_ID\"]}}</div></td>\n        <td style='text-align: center;  vertical-align: middle;font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>{{convMap[\"conversationLabel\"]}}</div></td>\n        <td style='text-align: center;  vertical-align: middle;font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>{{convMap[\"persona\"]}}</div></td>\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>{{convMap[\"duration\"]}}</div></td>\n        <td style='text-align: center;  vertical-align: middle; font-size: 12px; font-weight: bold;'><div style='padding-left: 5px; text-align: center; '>\n          <center>\n          <table border=0 cellspacing=5 cellpadding=1>\n          <tr><td  style=\"text-align: center; border-bottom: 1px solid grey; \">Input</td><td  style=\"text-align: center;  border-bottom: 1px solid grey; \">Cache</td><td   style=\"text-align: center;  border-bottom: 1px solid grey; \">Output</td></tr>\n          <tr><td  style=\"text-align: center; \">{{\"{:,}\".format(ns.input)}}</td><td  style=\"text-align: center; \">{{\"{:,}\".format(ns.cache)}}</td><td  style=\"text-align: center; \">{{\"{:,}\".format(ns.output)}}</td></tr>\n          </table>\n          </center>\n          </div>\n        </td>\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'><div style='padding-left: 5px;'>$ {{ns.cost}}</div></td>\n    </tr>\n    </table>\n   \n    {%- for c in convs -%}\n      {%- set ns.input = ns.input + c.get(\"token_usage_input_tokens\",0) -%}\n      {%- set ns.output = ns.input + c.get(\"token_usage_output_tokens\",0) -%}\n      {%- set ns.cache = ns.cache + c.get(\"token_usage_cache_tokens\",0) -%}\n\n\n      {%- set cache_tokens = 0 -%}\n      {%- if c.get(\"token_usage_cache_tokens\",0) -%}\n          {%-  set cache_tokens = c.get(\"token_usage_cache_tokens\",0)  -%}\n      {%- endif -%}\n      <div style='height: 10px;'></div>\n       \n       {%- if c[\"type\"] == \"client\" -%}\n          <hr></hr>\n\n          {%- set ns.prompts = ns.prompts + 1 -%}\n          <div style=\"display: flex; align-items: center; margin-top: 5px; color: #888888;\">\n          <img src='/assets/img/icons/featureApp/svgIcons/customer.svg' style=\"margin-right: 5px; width: 15px; height: auto;\"> <span> {{c[\"timestamp\"]}} <font color='#ffffff'>[<b>{{c[\"USER_ID\"]}}</b>] {{c[\"message\"]}} </font></span>\n          </div>\n         {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\n       {%- elif c[\"tool_name\"] -%}\n          {%- set highlighted = \"\" -%}\n          {%- if tool_name and tool_name == c[\"tool_name\"] -%}\n              {%- set highlighted = \"<font color='#00ffff' size=4><b> &check;&check; </b></font>\" -%}\n          {%- elif domain and c[\"tool_name\"].startswith(domain) -%}\n              {%- set highlighted = \"<font color='#00ffff' size=4><b> &check; </b></font>\" -%}\n          {%- endif -%}\n          {%- set td = str((to_datetime(c[\"timestamp\"])-ns.lasttime).to_pytimedelta()).split(\".\")[0] -%}\n          {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\n           <div style='padding: 0px 0px 0px 20px; color: #888888;'>\n           <details><summary> + {{td}} <font color='#ffff00'>[<b>{{c[\"llm\"]}}</b>] Tool Call: {{c[\"tool_name\"]}} </font> (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }}, Output:  {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }}, Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }}) {{highlighted}} </summary>\n         <div style=\"overflow: auto; width: 100%; height: 200px; padding: 5px 5px 5px 5px; border-left: 1px solid #ffff00; border-top: 0px solid #ffff00; border-right: 0px solid #ffff00; border-bottom: 0px solid #ffff00;\">\n          <pre>{{ c[\"codeBlocks\"].strip('{}').split(\":\", 1)[1] | trim | trim('\"') | replace('\\\\n', '\\n') | replace('\\\\\"', '\"') }}</pre>\n          </div>\n          </details>\n          </div>\n       {%- else  -%}   \n        {%- set td = str((to_datetime(c[\"timestamp\"])-ns.lasttime).to_pytimedelta()).split(\".\")[0] -%}\n        {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\n          <div style=\"display: flex; align-items: center; margin-top: 5px; color: #888888;\">\n            <img src='/assets/img/icons/featureApp/svgIcons/nlp.svg' style=\"margin-right: 5px; width: 15px; height: auto;\">\n              <details>\n                <summary>+ {{td}} <span style='color: #ff00ff;'>[<b>{{c[\"llm\"]}}</b>] Response </span> (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }}, Output: {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }}, Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }}) </summary>\n                <div style=\"overflow: auto; width: 90%; height: 200px; padding: 5px 5px 5px 5px; border-left: 1px solid #ff00ff; \">\n                  {{c[\"message\"]}}\n                </div>\n              </details>\n          </div>\n       {%- endif  -%}\n\n    {%- endfor -%}\n\n{%-else -%}\n   <b>Converation with ID {{conversation_id}} not found. May have been purged from the stream</b>\n{%- endif -%}\n\n\n\n</div>\n{%endraw%}"
      },
      {
          "name": "ai_cost_old_09_08_2025",
          "value": "{% raw %}\r\n<div style=\"overflow: auto; width: 100%; height: 100%; background-color: #000000; color: #ffffff; padding: 10px 10px 0px 20px;\">\r\n\r\n{% set llm_cost_query = ' * GET llm_name, input_token_cost_per1M, output_token_cost_per1M' %}\r\n{% set llm_costs = engine.query_stream_data(\r\n    \"llm_model_costs\",\r\n    cfxql_query=llm_cost_query,\r\n    sorting=[{\"timestamp\": \"asc\"}],\r\n    limit=100,\r\n    max_rows=100\r\n) %}\r\n{% set costs = {} %}\r\n{% for cost_row in llm_costs %}\r\n    {% set _ = costs.update({\r\n        cost_row.llm_name: [\r\n            cost_row.input_token_cost_per1M | float,\r\n            cost_row.output_token_cost_per1M | float\r\n        ]\r\n    }) %}\r\n{% endfor %}\r\n\r\n{%- set cfxql_query2 = \"conversationId = '\"+ conversation_id + \"' GET USER_ID,persona,message,conversationLabel,timestamp,type,llm,tool_name,token_usage_input_tokens,token_usage_cache_tokens,token_usage_output_tokens,tool_content,codeBlocks,_RDA_Id\" -%}\r\n\r\n{%- set convs = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query2, sorting=[{\"timestamp\": \"asc\"}, {\"_RDA_Id\": \"asc\"}], limit=1000, max_rows=1000) -%}\r\n\r\n{%- set ns = namespace(prompts=0, lasttime=\"\", input=0, output=0, cache=0, cost=0) -%}\r\n{%- if convs -%}\r\n    {%- set st = to_datetime(convs[0][\"timestamp\"]) -%}\r\n    {%- set et = to_datetime(convs[-1][\"timestamp\"]) -%}\r\n\r\n    {%- set convMap = {\r\n        \"USER_ID\": convs[0][\"USER_ID\"],\r\n        \"persona\": convs[0][\"persona\"],\r\n        \"conversationLabel\": convs[0][\"conversationLabel\"],\r\n        \"duration\": str((et-st).to_pytimedelta()).split(\".\")[0],\r\n        \"toolCount\": 0,\r\n        \"prompts\": 0,\r\n        \"cost\": \"\"\r\n      }\r\n    -%}\r\n    {%- for c in convs -%}\r\n      {%- set ns.input = ns.input + c.get(\"token_usage_input_tokens\",0) -%}\r\n      {%- set ns.output = ns.output + c.get(\"token_usage_output_tokens\",0) -%}\r\n      {%- set ns.cache = ns.cache + c.get(\"token_usage_cache_tokens\",0) -%}\r\n      {%- if costs.get(c.get(\"llm\", \"unknown\")) -%}\r\n        {%- set cm = costs.get(c.get(\"llm\", \"\"), [0, 0]) -%}\r\n        {%- set ns.cost = ns.cost + cm[0] *  c.get(\"token_usage_input_tokens\",0)/1000000.0 + cm[1]*c.get(\"token_usage_output_tokens\",0)/1000000.0 -%}\r\n      {%- endif -%}\r\n    {%- endfor -%}\r\n    {%- set ns.cost = ns.cost | round (4) -%}\r\n\r\n    <table width='90%' border=0 cellspacing=5 cellpadding=0>\r\n    <tr>\r\n        <td style='text-align: center; vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/customer.svg' style=\"width: 15px; height: auto; min-height: 10px; margin-right: 5px;\">\r\n            <span>User</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/collaboration.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Conversation Label</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/insights.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Persona</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/schedule.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Duration</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/nextSteps.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Tokens</span>\r\n          </div>\r\n        </td>\r\n\r\n        <td style='text-align: center;  vertical-align: middle;' >\r\n          <div style=\"display: inline-block; align-items: center;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/status.svg' style=\"width: 15px; height: auto; margin-right: 5px;\">\r\n            <span>Estimated Cost</span>\r\n          </div>\r\n        </td>\r\n    </tr>\r\n    <tr>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>{{convMap[\"USER_ID\"]}}</div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle;font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>{{convMap[\"conversationLabel\"]}}</div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle;font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>{{convMap[\"persona\"]}}</div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>{{convMap[\"duration\"]}}</div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 12px; font-weight: bold;'>\r\n          <div style='padding-left: 5px; text-align: center; '>\r\n            <center>\r\n              <table border=0 cellspacing=5 cellpadding=1>\r\n                <tr>\r\n                  <td  style=\"text-align: center; border-bottom: 1px solid grey; \">Input</td>\r\n                  <td  style=\"text-align: center;  border-bottom: 1px solid grey; \">Cache</td>\r\n                  <td   style=\"text-align: center;  border-bottom: 1px solid grey; \">Output</td>\r\n                </tr>\r\n                <tr>\r\n                  <td  style=\"text-align: center; \">{{\"{:,}\".format(ns.input)}}</td>\r\n                  <td  style=\"text-align: center; \">{{\"{:,}\".format(ns.cache)}}</td>\r\n                  <td  style=\"text-align: center; \">{{\"{:,}\".format(ns.output)}}</td>\r\n                </tr>\r\n              </table>\r\n            </center>\r\n          </div>\r\n        </td>\r\n        <td style='text-align: center;  vertical-align: middle; font-size: 18px; font-weight: bold;'>\r\n          <div style='padding-left: 5px;'>$ {{ns.cost}}</div>\r\n        </td>\r\n    </tr>\r\n    </table>\r\n\r\n    {%- for c in convs -%}\r\n      {%- set ns.input = ns.input + c.get(\"token_usage_input_tokens\",0) -%}\r\n      {%- set ns.output = ns.input + c.get(\"token_usage_output_tokens\",0) -%}\r\n      {%- set ns.cache = ns.cache + c.get(\"token_usage_cache_tokens\",0) -%}\r\n\r\n      {%- set cache_tokens = 0 -%}\r\n      {%- if c.get(\"token_usage_cache_tokens\",0) -%}\r\n          {%- set cache_tokens = c.get(\"token_usage_cache_tokens\",0) -%}\r\n      {%- endif -%}\r\n      <div style='height: 10px;'></div>\r\n\r\n       {%- if c[\"type\"] == \"client\" -%}\r\n          <hr></hr>\r\n\r\n          {%- set ns.prompts = ns.prompts + 1 -%}\r\n          <div style=\"display: flex; align-items: center; margin-top: 5px; color: #888888;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/customer.svg' style=\"margin-right: 5px; width: 15px; height: auto;\">\r\n            <span> {{c[\"timestamp\"]}} <font color='#ffffff'>[<b>{{c[\"USER_ID\"]}}</b>] {{c[\"message\"]}} </font></span>\r\n          </div>\r\n          {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n\r\n       {%- elif c.get(\"tool_name\") -%}\r\n          {%- set highlighted = \"\" -%}\r\n          {%- if tool_name and tool_name == c[\"tool_name\"] -%}\r\n              {%- set highlighted = \"<font color='#00ffff' size=4><b> &check;&check; </b></font>\" -%}\r\n          {%- elif domain and c[\"tool_name\"].startswith(domain) -%}\r\n              {%- set highlighted = \"<font color='#00ffff' size=4><b> &check; </b></font>\" -%}\r\n          {%- endif -%}\r\n          {%- set td = str((to_datetime(c[\"timestamp\"])-ns.lasttime).to_pytimedelta()).split(\".\")[0] -%}\r\n          {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n          <div style='padding: 0px 0px 0px 20px; color: #888888;'>\r\n            <details>\r\n              <summary>\r\n                + {{td}} <font color='#ffff00'>[<b>{{c[\"llm\"]}}</b>] Tool Call: {{c[\"tool_name\"]}} </font>\r\n                (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }},\r\n                 Output:  {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }},\r\n                 Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }})\r\n                {{highlighted}}\r\n              </summary>\r\n              <div style=\"overflow: auto; width: 100%; height: 200px; padding: 5px 5px 5px 5px; border-left: 1px solid #ffff00; border-top: 0px solid #ffff00; border-right: 0px solid #ffff00; border-bottom: 0px solid #ffff00;\">\r\n\r\n                {# Safely handle missing / empty codeBlocks #}\r\n                {%- set raw_code = c.get(\"codeBlocks\") -%}\r\n                {% if raw_code %}\r\n                  <pre>{{ raw_code.strip('{}').split(\":\", 1)[1] | trim | trim('\"') | replace('\\\\n', '\\n') | replace('\\\\\"', '\"') }}</pre>\r\n                {% else %}\r\n                  <pre>No codeBlocks available for this tool call.</pre>\r\n                {% endif %}\r\n\r\n              </div>\r\n            </details>\r\n          </div>\r\n\r\n       {%- else  -%}\r\n          {%- set td = str((to_datetime(c[\"timestamp\"])-ns.lasttime).to_pytimedelta()).split(\".\")[0] -%}\r\n          {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n          <div style=\"display: flex; align-items: center; margin-top: 5px; color: #888888;\">\r\n            <img src='/assets/img/icons/featureApp/svgIcons/nlp.svg' style=\"margin-right: 5px; width: 15px; height: auto;\">\r\n            <details>\r\n              <summary>\r\n                + {{td}} <span style='color: #ff00ff;'>[<b>{{c[\"llm\"]}}</b>] Response </span>\r\n                (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }},\r\n                 Output: {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }},\r\n                 Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }})\r\n              </summary>\r\n              <div style=\"overflow: auto; width: 90%; height: 200px; padding: 5px 5px 5px 5px; border-left: 1px solid #ff00ff; \">\r\n                {{c[\"message\"]}}\r\n              </div>\r\n            </details>\r\n          </div>\r\n       {%- endif  -%}\r\n\r\n    {%- endfor -%}\r\n\r\n{%- else -%}\r\n   <b>Conversation with ID {{conversation_id}} not found. May have been purged from the stream</b>\r\n{%- endif -%}\r\n\r\n</div>\r\n{% endraw %}\r\n"
      },
      {
          "name": "ai_costs",
          "value": "{% raw %}\r\n<div style=\"overflow:auto; width:100%; height:100%; background-color:#000000; color:#ffffff; padding:10px 10px 0px 20px;\">\r\n\r\n{% set llm_cost_query = ' * GET llm_name, input_token_cost_per1M, output_token_cost_per1M' %}\r\n{% set llm_costs = engine.query_stream_data(\r\n    \"llm_model_costs\",\r\n    cfxql_query=llm_cost_query,\r\n    sorting=[{\"llm_name\": \"asc\"}],\r\n    limit=100,\r\n    max_rows=100\r\n) %}\r\n\r\n{% set costs = {} %}\r\n{% for cost_row in llm_costs %}\r\n  {% set _ = costs.update({\r\n    cost_row.llm_name: [\r\n      cost_row.input_token_cost_per1M | float,\r\n      cost_row.output_token_cost_per1M | float\r\n    ]\r\n  }) %}\r\n{% endfor %}\r\n\r\n{%- set cfxql_query2 =\r\n    \"conversationId = '\"+ conversation_id +\r\n    \"' GET USER_ID, persona, message, conversationLabel, timestamp, type, llm, tool_name, \" +\r\n    \"token_usage_input_tokens, token_usage_cache_tokens, token_usage_output_tokens, \" +\r\n    \"tool_content, codeBlocks, isToolCall, _RDA_Id\"\r\n-%}\r\n\r\n{%- set convs = engine.query_stream_data(\r\n    \"rda_chat_sessions\",\r\n    cfxql_query=cfxql_query2,\r\n    sorting=[{\"timestamp\": \"asc\"}, {\"_RDA_Id\": \"asc\"}],\r\n    limit=1000,\r\n    max_rows=1000\r\n) -%}\r\n\r\n{%- set ns = namespace(prompts=0, lasttime=\"\", input=0, output=0, cache=0, cost=0) -%}\r\n\r\n{%- if convs -%}\r\n\r\n  {%- set st = to_datetime(convs[0][\"timestamp\"]) -%}\r\n  {%- set et = to_datetime(convs[-1][\"timestamp\"]) -%}\r\n\r\n  {%- for c in convs -%}\r\n    {%- set ns.input = ns.input + c.get(\"token_usage_input_tokens\", 0) -%}\r\n    {%- set ns.output = ns.output + c.get(\"token_usage_output_tokens\", 0) -%}\r\n    {%- set ns.cache = ns.cache + c.get(\"token_usage_cache_tokens\", 0) -%}\r\n\r\n    {%- if costs.get(c.get(\"llm\", \"unknown\")) -%}\r\n      {%- set cm = costs.get(c.get(\"llm\", \"\"), [0, 0]) -%}\r\n      {%- set ns.cost = ns.cost +\r\n          (cm[0] * c.get(\"token_usage_input_tokens\", 0) \/ 1000000.0) +\r\n          (cm[1] * c.get(\"token_usage_output_tokens\", 0) \/ 1000000.0)\r\n      -%}\r\n    {%- endif -%}\r\n  {%- endfor -%}\r\n  {%- set ns.cost = ns.cost | round(4) -%}\r\n\r\n  <table width=\"90%\" border=\"0\" cellspacing=\"5\" cellpadding=\"0\">\r\n    <tr>\r\n      <td style=\"text-align:center; vertical-align:middle;\">\r\n        <img src=\"\/assets\/img\/icons\/featureApp\/svgIcons\/customer.svg\" style=\"width:15px; margin-right:5px;\">\r\n        <span>User<\/span>\r\n      <\/td>\r\n      <td style=\"text-align:center; vertical-align:middle;\">\r\n        <img src=\"\/assets\/img\/icons\/featureApp\/svgIcons\/collaboration.svg\" style=\"width:15px; margin-right:5px;\">\r\n        <span>Conversation Label<\/span>\r\n      <\/td>\r\n      <td style=\"text-align:center; vertical-align:middle;\">\r\n        <img src=\"\/assets\/img\/icons\/featureApp\/svgIcons\/insights.svg\" style=\"width:15px; margin-right:5px;\">\r\n        <span>Persona<\/span>\r\n      <\/td>\r\n      <td style=\"text-align:center; vertical-align:middle;\">\r\n        <img src=\"\/assets\/img\/icons\/featureApp\/svgIcons\/schedule.svg\" style=\"width:15px; margin-right:5px;\">\r\n        <span>Duration<\/span>\r\n      <\/td>\r\n      <td style=\"text-align:center; vertical-align:middle;\">\r\n        <img src=\"\/assets\/img\/icons\/featureApp\/svgIcons\/nextSteps.svg\" style=\"width:15px; margin-right:5px;\">\r\n        <span>Tokens<\/span>\r\n      <\/td>\r\n      <td style=\"text-align:center; vertical-align:middle;\">\r\n        <img src=\"\/assets\/img\/icons\/featureApp\/svgIcons\/status.svg\" style=\"width:15px; margin-right:5px;\">\r\n        <span>Estimated Cost<\/span>\r\n      <\/td>\r\n    <\/tr>\r\n\r\n    <tr>\r\n      <td style=\"text-align:center; font-size:18px; font-weight:bold;\">{{ convs[0][\"USER_ID\"] }}<\/td>\r\n      <td style=\"text-align:center; font-size:18px; font-weight:bold;\">{{ convs[0][\"conversationLabel\"] }}<\/td>\r\n      <td style=\"text-align:center; font-size:18px; font-weight:bold;\">{{ convs[0][\"persona\"] }}<\/td>\r\n      <td style=\"text-align:center; font-size:18px; font-weight:bold;\">\r\n        {{ str((et - st).to_pytimedelta()).split(\".\")[0] }}\r\n      <\/td>\r\n\r\n      <td style=\"text-align:center; font-size:12px; font-weight:bold;\">\r\n        <center>\r\n          <table border=\"0\" cellspacing=\"5\" cellpadding=\"1\">\r\n            <tr>\r\n              <td style=\"border-bottom:1px solid grey;\">Input<\/td>\r\n              <td style=\"border-bottom:1px solid grey;\">Cache<\/td>\r\n              <td style=\"border-bottom:1px solid grey;\">Output<\/td>\r\n            <\/tr>\r\n            <tr>\r\n              <td>{{ \"{:,}\".format(ns.input) }}<\/td>\r\n              <td>{{ \"{:,}\".format(ns.cache) }}<\/td>\r\n              <td>{{ \"{:,}\".format(ns.output) }}<\/td>\r\n            <\/tr>\r\n          <\/table>\r\n        <\/center>\r\n      <\/td>\r\n\r\n      <td style=\"text-align:center; font-size:18px; font-weight:bold;\">$ {{ ns.cost }}<\/td>\r\n    <\/tr>\r\n  <\/table>\r\n\r\n  {%- set ns.lasttime = to_datetime(convs[0][\"timestamp\"]) -%}\r\n\r\n  {%- for c in convs -%}\r\n\r\n    {%- set td = str((to_datetime(c[\"timestamp\"]) - ns.lasttime).to_pytimedelta()).split(\".\")[0] -%}\r\n    {%- set ns.lasttime = to_datetime(c[\"timestamp\"]) -%}\r\n\r\n    <div style=\"height:10px;\"><\/div>\r\n\r\n    {%- if c[\"type\"] == \"client\" -%}\r\n      <hr>\r\n      <div style=\"display:flex; align-items:center; margin-top:5px; color:#888888;\">\r\n        <img src=\"\/assets\/img\/icons\/featureApp\/svgIcons\/customer.svg\" style=\"margin-right:5px; width:15px;\">\r\n        <span>\r\n          {{ c[\"timestamp\"] }}\r\n          <font color=\"#ffffff\">[<b>{{ c[\"USER_ID\"] }}<\/b>] {{ (c.get(\"message\") or \"\") | replace(\"<\",\"&lt;\") | replace(\">\",\"&gt;\") }}<\/font>\r\n        <\/span>\r\n      <\/div>\r\n\r\n    {%- elif c.get(\"tool_name\") -%}\r\n\r\n      <div style=\"padding-left:20px; color:#888888;\">\r\n        <details>\r\n          <summary>\r\n            + {{ td }}\r\n            <font color=\"#ffff00\">[<b>{{ c[\"llm\"] }}<\/b>] Tool Call: {{ c[\"tool_name\"] }}<\/font>\r\n            (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }},\r\n             Output: {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }},\r\n             Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }})\r\n          <\/summary>\r\n\r\n          <div style=\"overflow:auto; width:100%; height:200px; padding:5px; border-left:1px solid #ffff00;\">\r\n\r\n            {% set raw_block = \"\" %}\r\n            {% set cb = c.get(\"codeBlocks\") %}\r\n\r\n            {% if cb is mapping and cb.get(\"C0\") %}\r\n              {% set raw_block = cb.get(\"C0\") %}\r\n            {% elif cb is string and cb|trim %}\r\n              {% set raw_block = cb %}\r\n            {% else %}\r\n              {% set tool_args_fallback = c.get(\"message\") or \"\" %}\r\n              {% set tool_out_fallback = c.get(\"tool_content\") or \"\" %}\r\n              {% if tool_args_fallback|trim %}\r\n                {% set raw_block = raw_block + \"Arguments:\\n\" + tool_args_fallback + \"\\n\\n\" %}\r\n              {% endif %}\r\n              {% if tool_out_fallback|trim %}\r\n                {% set raw_block = raw_block + \"Result:\\n\" + tool_out_fallback %}\r\n              {% endif %}\r\n            {% endif %}\r\n\r\n            {% set args_txt = \"\" %}\r\n            {% set res_txt = \"\" %}\r\n\r\n            {% if raw_block and \"Arguments:\" in raw_block %}\r\n              {% set after_args = raw_block.split(\"Arguments:\", 1)[1] %}\r\n              {% if \"Result:\" in after_args %}\r\n                {% set args_txt = after_args.split(\"Result:\", 1)[0] | trim %}\r\n                {% set res_txt = after_args.split(\"Result:\", 1)[1] | trim %}\r\n              {% else %}\r\n                {% set args_txt = after_args | trim %}\r\n              {% endif %}\r\n            {% else %}\r\n              {% set args_txt = c.get(\"message\") or \"\" %}\r\n              {% set res_txt = c.get(\"tool_content\") or \"\" %}\r\n            {% endif %}\r\n\r\n            {# =====================================================\r\n               \u2705 Decode only \\\\, \\\" and \\n for tool args\/results\r\n               ===================================================== #}\r\n            {% set args_render = args_txt\r\n              | replace(\"\\\\\\\\\", \"\\\\\")\r\n              | replace('\\\\\"', '\"')\r\n              | replace(\"\\\\n\", \"\\n\")\r\n            %}\r\n\r\n            {% set res_render = res_txt\r\n              | replace(\"\\\\\\\\\", \"\\\\\")\r\n              | replace('\\\\\"', '\"')\r\n              | replace(\"\\\\n\", \"\\n\")\r\n            %}\r\n\r\n            {% if args_render|trim %}\r\n              <pre>Arguments:\r\n{{ args_render | replace(\"<\",\"&lt;\") | replace(\">\",\"&gt;\") }}<\/pre>\r\n            {% endif %}\r\n\r\n            {% if res_render|trim %}\r\n              <pre>Result:\r\n{{ res_render | replace(\"<\",\"&lt;\") | replace(\">\",\"&gt;\") }}<\/pre>\r\n            {% endif %}\r\n\r\n            {% if not args_render|trim and not res_render|trim %}\r\n              <pre>&nbsp;<\/pre>\r\n            {% endif %}\r\n\r\n          <\/div>\r\n        <\/details>\r\n      <\/div>\r\n\r\n    {%- else -%}\r\n\r\n      {% set resp = c.get(\"message\") %}\r\n      {% if not resp %}\r\n        {% set resp = c.get(\"tool_content\") %}\r\n      {% endif %}\r\n\r\n      <div style=\"display:flex; align-items:center; margin-top:5px; color:#888888;\">\r\n        <img src=\"\/assets\/img\/icons\/featureApp\/svgIcons\/nlp.svg\" style=\"margin-right:5px; width:15px;\">\r\n        <details>\r\n          <summary>\r\n            + {{ td }}\r\n            <span style=\"color:#ff00ff;\">[<b>{{ c[\"llm\"] }}<\/b>] Response<\/span>\r\n            (TOKENS Input: {{ \"{:,}\".format(c.get(\"token_usage_input_tokens\", 0)) }},\r\n             Output: {{ \"{:,}\".format(c.get(\"token_usage_output_tokens\", 0)) }},\r\n             Cache: {{ \"{:,}\".format(c.get(\"token_usage_cache_tokens\", 0)) }})\r\n          <\/summary>\r\n\r\n          {# \u2705 Always render HTML response (no escaping) #}\r\n          <div style=\"overflow:auto; width:90%; height:200px; padding:5px; border-left:1px solid #ff00ff;\">\r\n            {{ resp or \"\" }}\r\n          <\/div>\r\n        <\/details>\r\n      <\/div>\r\n\r\n    {%- endif -%}\r\n\r\n  {%- endfor -%}\r\n\r\n{%- else -%}\r\n  <b>Conversation with ID {{ conversation_id }} not found. May have been purged from the stream.<\/b>\r\n{%- endif -%}\r\n\r\n<\/div>\r\n{% endraw %}\r\n",
          "additionalFields": {
              "valueType": "",
              "description": ""
          }
      }
  ]
}