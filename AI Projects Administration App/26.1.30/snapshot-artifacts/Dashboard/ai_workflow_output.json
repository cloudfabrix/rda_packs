{
  "name": "ai_workflow_output",
  "label": "Workflow Output",
  "is_template": false,
  "description": "AI Agent Job Details",
  "live_edit": true,
  "version": "25.7.8.1",
  "enabled": true,
  "dashboard_folder": "workflows",
  "dashboard_type": "dashboard",
  "dashboard_style": "tabbed",
  "use_storyboard": false,
  "default_storyboard": null,
  "dashboard_generator": {
    "attachment": "generator"
  },
  "template_variables": {
    "JOB_ID": {
      "contextId": "conversationId"
    },
    "FLOW_NAME": {
      "contextId": "conversationLabel"
    }
  },
  "dashboard_filters": {},
  "dashboard_sections": [
    {
      "title": "Output",
      "widgets": [
        {
          "title": "Workflow View",
          "widget_type": "label",
          "label": "attachment://agentOutput",
          "advanced": true,
          "uses_reporting_engine": true,
          "fixed_variables": {
            "agent_name": "{{FLOW_NAME}}",
            "job_id": "{{JOB_ID}}"
          },
          "widget_id": "accfc497",
          "min_width": 12,
          "max_width": 12,
          "height": 8
        }
      ]
    }
  ],
  "attachments": [
    {
      "name": "showOutput_old",
      "value": "{%- if conversationId is not defined or conversationLabel is not defined -%}\n  <div style=\"color:red; font-weight:bold;\">\n    \u26a0\ufe0f conversationId or conversationLabel not found in context\n  </div>\n{%- else -%}\n\n  {# ---- Query messages ---- #}\n  {%- set cfxql_query = \"conversationId = '\" ~ (conversationId|default('')) ~ \"' and final_response = 'true' and conversationLabel = '\" ~ (conversationLabel|default('')) ~ \"' GET message\" -%}\n  {%- set rows = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query, limit=2, max_rows=2, sorting=[{\"timestamp\": \"asc\"}]) | default([], true) -%}\n\n  {%- if rows|length == 0 -%}\n    <div style=\"color:gray;\">\n      \u2139\ufe0f This Conversation does not yet have any outputs.\n    </div>\n  {%- else -%}\n    {%- set raw_message = rows[0].get(\"message\") | default(\"\", true) | string -%}\n    {%- set message_out = raw_message -%}\n\n    {# ---- Handle JSON safely ---- #}\n    {%- if raw_message is string and raw_message.strip()|length > 0 and raw_message.strip().startswith(\"json\") -%}\n      {%- set stripped = (raw_message[4:] | default(\"\", true) | string).strip() -%}\n      {%- if stripped|length > 0 -%}\n        {%- set parsed = \"\" -%}\n        {%- if stripped is string and stripped|length > 0 -%}\n          {%- set parsed = json_loads(stripped) | default(\"\", true) -%}\n        {%- endif -%}\n        {%- if parsed -%}\n          {%- set message_out = json_dumps_indent(parsed, indent=2) | default(\"\u26a0\ufe0f JSON dump failed\", true) -%}\n        {%- else -%}\n          {%- set message_out = \"\u26a0\ufe0f Failed to parse JSON content.\" -%}\n        {%- endif -%}\n      {%- else -%}\n        {%- set message_out = \"\u26a0\ufe0f Empty JSON content.\" -%}\n      {%- endif -%}\n    {%- endif -%}\n\n    {# ---- Render Output ---- #}\n    <div style=\"width:100%; height:100%; overflow:auto;\">\n      {%- if message_out is string and not message_out.strip().startswith(\"<\") -%}\n        <div style=\"white-space: pre-wrap;\">{{ message_out }}</div>\n      {%- else -%}\n        {{ message_out }}\n      {%- endif -%}\n    </div>\n  {%- endif -%}\n{%- endif -%}\n"
    },
    {
      "name": "agentOutput",
      "value": "<div style=\"overflow: auto;\">\r\n\r\n{% if job_id is not defined or not job_id or agent_name is not defined or not agent_name %}\r\n    <h3 style=\"color: red;\">\u26a0\ufe0f Error: Job ID or Agent Name not found. Cannot display workflow output.</h3>\r\n{% else %}\r\n\r\n    {% set query = \"jobId = '\" ~ job_id ~ \"'\" %}\r\n    {% set ns = namespace(eval_output=\"No Evaluation Status\", agent_output=\"No Output Yet\", last_updated=\"\") %}\r\n\r\n    {% set data = engine.query_stream_data(\r\n        \"agent_output_stream\",\r\n        cfxql_query=query,\r\n        sorting=[{\"timestamp\": \"desc\"}]\r\n    ) %}\r\n\r\n    {% if data and data|length > 0 %}\r\n        {% set ns.last_updated = data[0][\"timestamp\"] %}\r\n    {% endif %}\r\n\r\n    {% for row in data %}\r\n        {# --- Evaluation output --- #}\r\n        {% if row.get(\"evaluation_output_0\") %}\r\n            {% set raw_eval = row.get(\"evaluation_output_0\") %}\r\n            {% set clean_eval = raw_eval.replace(\"```\", \"\").replace(\"json\", \"\").strip() %}\r\n            {% set ns.eval_output = json_loads(clean_eval).get(\"agent_run\", \"\") %}\r\n        {% endif %}\r\n\r\n        {# --- Agent output concatenation --- #}\r\n        {% set num_parts_raw = row.get(\"agent_output_num_parts\") %}\r\n        {% if num_parts_raw is string %}\r\n            {% set num_parts = num_parts_raw | int %}\r\n        {% else %}\r\n            {% set num_parts = num_parts_raw or 0 %}\r\n        {% endif %}\r\n\r\n        {% set output_buffer = \"\" %}\r\n\r\n        {% if num_parts > 0 %}\r\n            {% for i in range(0, num_parts) %}\r\n                {% set key = \"agent_output_\" ~ i %}\r\n                {% set part = row.get(key) %}\r\n                {% if part %}\r\n                    {% if i == 0 %}\r\n                        {# Clean only the first part #}\r\n                        {% set cleaned_first = part\r\n                            | replace(\"```html\", \"\")\r\n                            | replace(\"```\", \"\")\r\n                            | trim\r\n                        %}\r\n                        {% set output_buffer = output_buffer + cleaned_first %}\r\n                    {% else %}\r\n                        {# Append others as-is #}\r\n                        {% set output_buffer = output_buffer + part %}\r\n                    {% endif %}\r\n                {% endif %}\r\n            {% endfor %}\r\n            {% set ns.agent_output = output_buffer %}\r\n        {% elif row.get(\"agent_output_0\") %}\r\n            {% set ns.agent_output = row.get(\"agent_output_0\")\r\n                | replace(\"```html\", \"\")\r\n                | replace(\"```\", \"\")\r\n                | trim\r\n            %}\r\n        {% endif %}\r\n    {% endfor %}\r\n\r\n    {# --- Color status --- #}\r\n    {% if ns.eval_output == \"Success\" %}\r\n        {% set ns.eval_output = \"<font style='color: #22dd22;'>\" ~ ns.eval_output ~ \"</font>\" %}\r\n    {% elif ns.eval_output == \"Failure\" %}\r\n        {% set ns.eval_output = \"<font style='color: #ff2511;'>\" ~ ns.eval_output ~ \"</font>\" %}\r\n    {% endif %}\r\n\r\n    <h3>{{ agent_name }}</h3>\r\n    <h3>Last Updated: {{ ns.last_updated }}</h3>\r\n    <h3>Status: {{ ns.eval_output | safe }}</h3>\r\n\r\n    <h3>\ud83e\udde9 Debug: Concatenated HTML Code</h3>\r\n    <div style=\"max-height: 250px; overflow: auto; background-color: #000; color: #0f0; padding: 10px; border-radius: 8px; font-family: monospace; white-space: pre-wrap;\">\r\n        {{ ns.agent_output | e }}\r\n    </div>\r\n\r\n    <h3>Rendered Output:</h3>\r\n    <hr/>\r\n    <div style=\"max-height: 80vh; overflow: auto; background-color: #111; color: #fff; padding: 15px; border-radius: 10px;\">\r\n        {{ ns.agent_output | safe }}\r\n    </div>\r\n\r\n{% endif %}\r\n</div>\r\n"
    },
    {
      "name": "evalOutput",
      "value": "{%raw%}\r\n\r\n<div style=\"overflow: auto;\">\r\n{%- \r\n    set query = \"jobId = '\" + job_id + \"'\"\r\n-%}\r\n\r\n{%\r\n    set ns = namespace(eval_output=\"No Evaluation Status\", agent_output=\"No Output Yet\", last_updated=\"\")\r\n%}\r\n\r\n{%- \r\n    set data = engine.query_stream_data(\"agent_output_stream\", cfxql_query=query, sorting=[{\"timestamp\": \"desc\" }]) \r\n-%}\r\n\r\n{%-if len(data) > 0 -%}\r\n    {%- set ns.last_updated = data[0][\"timestamp\"] -%}\r\n{%- endif -%}\r\n\r\n{%-for row in data -%}\r\n    {%-if row.get(\"evaluation_output_0\", \"\") -%}\r\n        {%- set ns.eval_output = json_loads(row.get(\"evaluation_output_0\").strip(\"```\").lstrip(\"json\").strip(\" \")).get(\"agent_run\", \"\")  -%}\r\n    {%- endif -%}\r\n     {%-if row.get(\"agent_output_0\", \"\") -%}\r\n        {%- set ns.agent_output = row.get(\"agent_output_0\").strip(\"```\").lstrip(\"html\")  -%}\r\n    {%- endif -%}\r\n{%- endfor -%}\r\n\r\n{%- if ns.eval_output == \"Success\" -%}\r\n    {%- set ns.eval_output = \"<font style='color: #22dd22;'>\"+ns.eval_output + \"</font>\"-%}\r\n{%- elif ns.eval_output == \"Failure\" -%}\r\n    {%- set ns.eval_output = \"<font style='color: #ff2511;'>\"+ns.eval_output + \"</font>\"-%}\r\n{%- endif -%}\r\n\r\n<h3>{{agent_name}}</h3>\r\n<h3>Last Updated: {{ns.last_updated}}</h3>\r\n<h3>Status: {{ns.eval_output}}</h3>\r\n<h3>Output:</h3>\r\n<hr/>\r\n{{ns.agent_output}}\r\n\r\n</div>\r\n{%endraw%}"
    },
    {
      "name": "generator",
      "value": "{{ dashboard[\"dashboard_sections\"].clear() }}\r\n\r\n{% if conversationId is not defined or conversationId == \"\" %}\r\n    <div style=\"background-color: black; color: red; font-weight: bold; padding: 10px;\">\r\n        \u26a0\ufe0f Conversation ID is missing or empty. Cannot proceed further.\r\n    </div>\r\n    {%- set message = \"conversationId is missing or empty\" -%}\r\n    \r\n    {{ dashboard[\"dashboard_sections\"].append({\r\n        \"title\": \"No Output\",\r\n        \"widgets\": [{\r\n            \"widget_type\": \"label\",\r\n            \"uses_reporting_engine\": true,\r\n            \"fixed_variables\": {},\r\n            \"height\": 1,\r\n            \"max_width\": 12,\r\n            \"label\": message,\r\n            \"widget_id\": \"header1\",\r\n            \"style\": {\"background-color\": \"black\", \"color\": \"red\", \"font-weight\": \"bold\", \"padding\": \"10px\"}\r\n        }]\r\n    }) }}\r\n{% else %}\r\n    {%- set message = \"\" -%}\r\n\r\n    {%- set cfxql_query = \"conversationId = '\"+str(conversationId)+\"' and final_response = 'true' GET conversationLabel\" -%}\r\n\r\n    {%- set rows = engine.query_stream_data(\r\n        \"rda_chat_sessions\",\r\n        cfxql_query=cfxql_query,\r\n        limit=100,\r\n        max_rows=100,\r\n        sorting=[{\"timestamp\": \"asc\"}]\r\n    ) -%}\r\n\r\n    {%- if not rows -%}\r\n        {%- set message = \"This Conversation does not yet have any outputs\" -%}\r\n        {{ dashboard[\"dashboard_sections\"].append({\r\n            \"title\": \"No Output\",\r\n            \"widgets\": [{\r\n                \"widget_type\": \"label\",\r\n                \"uses_reporting_engine\": true,\r\n                \"fixed_variables\": {\r\n                    \"conversationId\": conversationId,\r\n                    \"conversation_id\": conversationId\r\n                },\r\n                \"height\": 1,\r\n                \"max_width\": 12,\r\n                \"label\": message,\r\n                \"widget_id\": \"header1\",\r\n                \"style\": {\"background-color\": \"black\", \"color\": \"red\", \"font-weight\": \"bold\", \"padding\": \"10px\"}\r\n            }]\r\n        }) }}\r\n    {%- else -%}\r\n        {%- for r in rows -%}\r\n            {{ dashboard[\"dashboard_sections\"].append({\r\n                \"title\": r.get(\"conversationLabel\", \"?\"),\r\n                \"widgets\": [{\r\n                    \"widget_type\": \"label\",\r\n                    \"uses_reporting_engine\": true,\r\n                    \"fixed_variables\": {\r\n                        \"conversationId\": conversationId,\r\n                        \"conversation_id\": conversationId,\r\n                        \"conversationLabel\": r[\"conversationLabel\"]\r\n                    },\r\n                    \"label\": \"attachment://showOutput\",\r\n                    \"height\": 12,\r\n                    \"max_width\": 12,\r\n                    \"widget_id\": \"label\"+str(len(dashboard[\"dashboard_sections\"]))\r\n                }]\r\n            }) }}\r\n        {%- endfor -%}\r\n    {%- endif -%}\r\n{% endif %}\r\n"
    },
    {
      "name": "showOutput",
      "value": "{%- if conversationId is not defined or conversationLabel is not defined -%}\r\n  <div style=\"color:red; font-weight:bold;\">\r\n    \u26a0\ufe0f conversationId or conversationLabel not found in context\r\n  </div>\r\n{%- else -%}\r\n\r\n  {# ---- Query messages ---- #}\r\n  {%- set cfxql_query = \"conversationId = '\" ~ (conversationId|default('')) ~ \"' and final_response = 'true' and conversationLabel = '\" ~ (conversationLabel|default('')) ~ \"'\" -%}\r\n  {%- set rows = engine.query_stream_data(\"rda_chat_sessions\", cfxql_query=cfxql_query, limit=1, max_rows=2, sorting=[{\"timestamp\": \"asc\"}]) | default([], true) -%}\r\n\r\n  {%- if rows|length == 0 -%}\r\n    <div style=\"color:gray;\">\r\n      \u2139\ufe0f This Conversation does not yet have any outputs.\r\n    </div>\r\n  {%- else -%}\r\n    {%- set row = rows[0] -%}\r\n    {%- set num_parts = row.get(\"num_message_parts\") | default(1, true) | int -%}\r\n\r\n    {# ---- Concatenate message parts using namespace ---- #}\r\n    {%- set ns = namespace(full_message = row.get(\"message\") | default(\"\", true)) -%}\r\n    {%- for i in range(1, num_parts) -%}\r\n      {%- set part_key = \"message_\" ~ i -%}\r\n      {%- set part_value = row.get(part_key) | default(\"\", true) -%}\r\n      {%- set ns.full_message = ns.full_message + part_value -%}\r\n    {%- endfor -%}\r\n\r\n    {%- set message_out = ns.full_message -%}\r\n\r\n    {# ---- Handle JSON safely ---- #}\r\n    {%- if message_out is string and message_out.strip()|length > 0 and message_out.strip().startswith(\"json\") -%}\r\n      {%- set stripped = (message_out[4:] | default(\"\", true) | string).strip() -%}\r\n      {%- if stripped|length > 0 -%}\r\n        {%- set parsed = \"\" -%}\r\n        {%- if stripped is string and stripped|length > 0 -%}\r\n          {%- set parsed = json_loads(stripped) | default(\"\", true) -%}\r\n        {%- endif -%}\r\n        {%- if parsed -%}\r\n          {%- set message_out = json_dumps_indent(parsed, indent=2) | default(\"\u26a0\ufe0f JSON dump failed\", true) -%}\r\n        {%- else -%}\r\n          {%- set message_out = \"\u26a0\ufe0f Failed to parse JSON content.\" -%}\r\n        {%- endif -%}\r\n      {%- else -%}\r\n        {%- set message_out = \"\u26a0\ufe0f Empty JSON content.\" -%}\r\n      {%- endif -%}\r\n    {%- endif -%}\r\n\r\n    {# ---- Render Output ---- #}\r\n    <div style=\"width:100%; height:100%; overflow:auto;\">\r\n      {%- if message_out is string and not message_out.strip().startswith(\"<\") -%}\r\n        <div style=\"white-space: pre-wrap;\">{{ message_out }}</div>\r\n      {%- else -%}\r\n        {{ message_out }}\r\n      {%- endif -%}\r\n    </div>\r\n  {%- endif -%}\r\n{%- endif -%}\r\n"
    }
  ]
}